# PktMask æµ‹è¯•è„šæœ¬æ¸…ç†è¡ŒåŠ¨è®¡åˆ’

> **åˆ¶å®šæ—¥æœŸ**: 2025-07-25  
> **æ‰§è¡ŒæœŸé™**: 1å‘¨å†…å®Œæˆ  
> **ç›®æ ‡**: å°†æµ‹è¯•æˆåŠŸç‡ä»53%æå‡è‡³95%ä»¥ä¸Š

## ğŸ¯ æ¸…ç†ç›®æ ‡

### ä¸»è¦ç›®æ ‡
1. **ä¿®å¤1ä¸ªå®Œå…¨å¤±æ•ˆçš„æµ‹è¯•æ–‡ä»¶**
2. **ä¿®å¤6ä¸ªéƒ¨åˆ†å¤±æ•ˆçš„æµ‹è¯•æ–‡ä»¶**
3. **å»ºç«‹æµ‹è¯•è´¨é‡ä¿è¯æœºåˆ¶**
4. **æ¸…ç†ä¸´æ—¶è°ƒè¯•ä»£ç å’Œè¿‡æ—¶å¼•ç”¨**

### æˆåŠŸæ ‡å‡†
- [ ] æµ‹è¯•æˆåŠŸç‡è¾¾åˆ°95%ä»¥ä¸Š
- [ ] æ‰€æœ‰å¯¼å…¥è·¯å¾„æ­£ç¡®ä¸”ä¸€è‡´
- [ ] æ— è¿‡æ—¶å¼•ç”¨å’Œæ–­è¨€é”™è¯¯
- [ ] å»ºç«‹è‡ªåŠ¨åŒ–æµ‹è¯•è´¨é‡æ£€æŸ¥

## ğŸ“‹ å…·ä½“è¡ŒåŠ¨æ¸…å•

### ğŸ”´ ç¬¬1å¤©: é«˜ä¼˜å…ˆçº§ä¿®å¤ (2å°æ—¶)

#### ä»»åŠ¡1.1: ä¿®å¤å¯¼å…¥è·¯å¾„é”™è¯¯ (30åˆ†é’Ÿ)
**æ–‡ä»¶**: `tests/unit/test_temporary_file_management.py`

**æ“ä½œæ­¥éª¤**:
1. æ‰“å¼€æ–‡ä»¶ `tests/unit/test_temporary_file_management.py`
2. æ‰¾åˆ°ç¬¬20è¡Œçš„é”™è¯¯å¯¼å…¥:
   ```python
   from pktmask.core.pipeline.stages.masking_stage.stage import MaskingStage
   ```
3. æ›¿æ¢ä¸ºæ­£ç¡®å¯¼å…¥:
   ```python
   from pktmask.core.pipeline.stages.masking_stage.stage import MaskingStage
   ```
4. æŸ¥æ‰¾å¹¶æ›¿æ¢æ‰€æœ‰ `MaskingStage` ä¸º `MaskingStage`
5. è¿è¡Œæµ‹è¯•éªŒè¯: `python -m pytest tests/unit/test_temporary_file_management.py -v`

**éªŒè¯æ ‡å‡†**: æµ‹è¯•æ–‡ä»¶èƒ½å¤ŸæˆåŠŸåŠ è½½ï¼Œæ— å¯¼å…¥é”™è¯¯

#### ä»»åŠ¡1.2: ä¿®å¤æµ‹è¯•æ–­è¨€é”™è¯¯ (60åˆ†é’Ÿ)
**æ–‡ä»¶**: `tests/unit/test_masking_stage_stage.py`

**æ“ä½œæ­¥éª¤**:
1. **ä¿®å¤æ˜¾ç¤ºåç§°æ–­è¨€** (15åˆ†é’Ÿ):
   - æ‰¾åˆ° `test_display_name_and_description` æ–¹æ³•
   - å°†æ–­è¨€ä» `"Mask Payloads (v2)"` æ”¹ä¸º `"Mask Payloads"`

2. **ç§»é™¤ä¸å­˜åœ¨æ–¹æ³•å¼•ç”¨** (30åˆ†é’Ÿ):
   - æ‰¾åˆ° `test_process_file_integration` å’Œ `test_process_file_without_initialization`
   - ç§»é™¤æˆ–æ›¿æ¢ `validate_inputs` æ–¹æ³•å¼•ç”¨
   - ä½¿ç”¨å®é™…å­˜åœ¨çš„æ–¹æ³•è¿›è¡Œæµ‹è¯•

3. **ä¿®å¤é…ç½®æµ‹è¯•** (15åˆ†é’Ÿ):
   - æ‰¾åˆ° `test_default_config_values` æ–¹æ³•
   - æ›´æ–°é…ç½®æœŸæœ›å€¼ï¼Œé€‚é…æ–°çš„é…ç½®ç»“æ„

**éªŒè¯æ ‡å‡†**: æ‰€æœ‰9ä¸ªæµ‹è¯•éƒ½èƒ½é€šè¿‡

#### ä»»åŠ¡1.3: éªŒè¯ä¿®å¤æ•ˆæœ (30åˆ†é’Ÿ)
**æ“ä½œæ­¥éª¤**:
1. è¿è¡Œä¿®å¤çš„æµ‹è¯•æ–‡ä»¶:
   ```bash
   python -m pytest tests/unit/test_temporary_file_management.py -v
   python -m pytest tests/unit/test_masking_stage_stage.py -v
   ```
2. æ£€æŸ¥æµ‹è¯•é€šè¿‡ç‡
3. è®°å½•ä¿®å¤ç»“æœ

**éªŒè¯æ ‡å‡†**: ä¸¤ä¸ªæ–‡ä»¶çš„æµ‹è¯•éƒ½èƒ½æˆåŠŸè¿è¡Œ

### ğŸŸ¡ ç¬¬2-3å¤©: ä¸­ä¼˜å…ˆçº§ä¿®å¤ (4å°æ—¶)

#### ä»»åŠ¡2.1: éªŒè¯å¯ç–‘æµ‹è¯•æ–‡ä»¶ (2å°æ—¶)
**æ–‡ä»¶åˆ—è¡¨**:
- `test_masking_stage_masker.py`
- `test_masking_stage_tls_marker.py`
- `test_tls_flow_analyzer.py`
- `test_unified_services.py`

**æ“ä½œæ­¥éª¤** (æ¯ä¸ªæ–‡ä»¶30åˆ†é’Ÿ):
1. è¿è¡Œæµ‹è¯•: `python -m pytest tests/unit/[æ–‡ä»¶å] -v --tb=short`
2. è¯†åˆ«å¤±è´¥åŸå› :
   - é…ç½®é—®é¢˜
   - ä¾èµ–ç¼ºå¤±
   - æµ‹è¯•æ•°æ®ç¼ºå¤±
   - å¤–éƒ¨å·¥å…·ä¾èµ–
3. è®°å½•é—®é¢˜å’Œä¿®å¤æ–¹æ¡ˆ
4. å®æ–½ä¿®å¤
5. éªŒè¯ä¿®å¤æ•ˆæœ

#### ä»»åŠ¡2.2: ä¿®å¤è¿è¡Œæ—¶é—®é¢˜ (2å°æ—¶)
æ ¹æ®ä»»åŠ¡2.1çš„å‘ç°ï¼Œé’ˆå¯¹æ€§ä¿®å¤:

**å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ**:
1. **é…ç½®é—®é¢˜**: æ·»åŠ ç¼ºå¤±çš„é…ç½®æ–‡ä»¶æˆ–Mocké…ç½®
2. **ä¾èµ–ç¼ºå¤±**: å®‰è£…ç¼ºå¤±çš„PythonåŒ…æˆ–Mockä¾èµ–
3. **æµ‹è¯•æ•°æ®ç¼ºå¤±**: åˆ›å»ºMockæµ‹è¯•æ•°æ®æˆ–æ·»åŠ çœŸå®æµ‹è¯•æ–‡ä»¶
4. **å¤–éƒ¨å·¥å…·ä¾èµ–**: Mockå¤–éƒ¨å·¥å…·è°ƒç”¨ï¼ˆå¦‚tsharkï¼‰

### ğŸŸ¢ ç¬¬4-5å¤©: è´¨é‡ä¿è¯å’Œè‡ªåŠ¨åŒ– (4å°æ—¶)

#### ä»»åŠ¡3.1: å»ºç«‹æµ‹è¯•CIæ£€æŸ¥ (2å°æ—¶)
**æ“ä½œæ­¥éª¤**:
1. åˆ›å»ºæµ‹è¯•å¯¼å…¥æ£€æŸ¥è„šæœ¬
2. åˆ›å»ºæµ‹è¯•è´¨é‡éªŒè¯è„šæœ¬
3. é›†æˆåˆ°CI/CDæµç¨‹
4. æµ‹è¯•è‡ªåŠ¨åŒ–æ£€æŸ¥

#### ä»»åŠ¡3.2: æ¸…ç†ä¸´æ—¶è°ƒè¯•ä»£ç  (1å°æ—¶)
**æ“ä½œæ­¥éª¤**:
1. æœç´¢ä¸´æ—¶è°ƒè¯•ä»£ç æ¨¡å¼:
   ```bash
   grep -r "print(" tests/
   grep -r "TODO" tests/
   grep -r "FIXME" tests/
   grep -r "DEBUG" tests/
   ```
2. æ¸…ç†æˆ–æ­£å¼åŒ–ä¸´æ—¶ä»£ç 
3. æ›´æ–°æ³¨é‡Šå’Œæ–‡æ¡£

#### ä»»åŠ¡3.3: æ–‡æ¡£æ›´æ–° (1å°æ—¶)
**æ“ä½œæ­¥éª¤**:
1. æ›´æ–°æµ‹è¯•æ–‡æ¡£
2. åˆ›å»ºæµ‹è¯•ç»´æŠ¤æŒ‡å—
3. æ›´æ–°é¡¹ç›®READMEä¸­çš„æµ‹è¯•éƒ¨åˆ†

## ğŸ”§ ä¿®å¤è„šæœ¬å’Œå·¥å…·

### è‡ªåŠ¨åŒ–å¯¼å…¥è·¯å¾„ä¿®å¤è„šæœ¬
```bash
#!/bin/bash
# scripts/fix_test_imports.sh

echo "ğŸ”§ ä¿®å¤æµ‹è¯•æ–‡ä»¶å¯¼å…¥è·¯å¾„..."

# ä¿®å¤masking_stageå¯¼å…¥
find tests/ -name "*.py" -exec sed -i '' \
  's/pktmask\.core\.pipeline\.stages\.masking_stage\.stage/pktmask.core.pipeline.stages.masking_stage.stage/g' {} \;

# ä¿®å¤ç±»åå¼•ç”¨
find tests/ -name "*.py" -exec sed -i '' \
  's/MaskingStage/MaskingStage/g' {} \;

echo "âœ… å¯¼å…¥è·¯å¾„ä¿®å¤å®Œæˆ"
```

### æµ‹è¯•éªŒè¯è„šæœ¬
```bash
#!/bin/bash
# scripts/validate_tests.sh

echo "ğŸ” éªŒè¯æµ‹è¯•æ–‡ä»¶çŠ¶æ€..."

# æ£€æŸ¥å¯¼å…¥é”™è¯¯
python -c "
import sys
from pathlib import Path
import subprocess

test_files = list(Path('tests/unit').glob('*.py'))
failed_files = []

for test_file in test_files:
    try:
        result = subprocess.run([
            'python', '-m', 'pytest', str(test_file), '--collect-only', '-q'
        ], capture_output=True, text=True, timeout=30)
        
        if result.returncode == 0:
            print(f'âœ… {test_file.name}: æ”¶é›†æˆåŠŸ')
        else:
            print(f'âŒ {test_file.name}: æ”¶é›†å¤±è´¥')
            failed_files.append(test_file.name)
    except Exception as e:
        print(f'âŒ {test_file.name}: {e}')
        failed_files.append(test_file.name)

print(f'\nğŸ“Š æ€»ç»“: {len(test_files) - len(failed_files)}/{len(test_files)} æ–‡ä»¶æ­£å¸¸')
if failed_files:
    print(f'âŒ å¤±è´¥æ–‡ä»¶: {failed_files}')
    sys.exit(1)
"
```

### ä¸´æ—¶è°ƒè¯•ä»£ç æ¸…ç†è„šæœ¬
```bash
#!/bin/bash
# scripts/cleanup_debug_code.sh

echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶è°ƒè¯•ä»£ç ..."

# æŸ¥æ‰¾å¯ç–‘çš„è°ƒè¯•ä»£ç 
echo "ğŸ” æŸ¥æ‰¾ä¸´æ—¶è°ƒè¯•ä»£ç :"
grep -rn "print(" tests/ --include="*.py" | head -10
grep -rn "TODO" tests/ --include="*.py" | head -10
grep -rn "FIXME" tests/ --include="*.py" | head -10

echo "ğŸ“ è¯·æ‰‹åŠ¨å®¡æŸ¥ä¸Šè¿°ä»£ç å¹¶å†³å®šæ˜¯å¦æ¸…ç†"
```

## ğŸ“Š è¿›åº¦è·Ÿè¸ª

### æ¯æ—¥æ£€æŸ¥æ¸…å•

#### ç¬¬1å¤©å®Œæˆæ ‡å‡†
- [ ] `test_temporary_file_management.py` å¯¼å…¥é”™è¯¯ä¿®å¤
- [ ] `test_masking_stage_stage.py` æ–­è¨€é”™è¯¯ä¿®å¤
- [ ] ä¸¤ä¸ªæ–‡ä»¶æµ‹è¯•é€šè¿‡ç‡è¾¾åˆ°100%

#### ç¬¬2-3å¤©å®Œæˆæ ‡å‡†
- [ ] 4ä¸ªå¯ç–‘æµ‹è¯•æ–‡ä»¶çŠ¶æ€ç¡®è®¤
- [ ] è¯†åˆ«çš„é—®é¢˜å…¨éƒ¨ä¿®å¤
- [ ] æ•´ä½“æµ‹è¯•é€šè¿‡ç‡è¾¾åˆ°90%ä»¥ä¸Š

#### ç¬¬4-5å¤©å®Œæˆæ ‡å‡†
- [ ] CI/CDæµ‹è¯•æ£€æŸ¥å»ºç«‹
- [ ] ä¸´æ—¶è°ƒè¯•ä»£ç æ¸…ç†å®Œæˆ
- [ ] æµ‹è¯•æ–‡æ¡£æ›´æ–°å®Œæˆ
- [ ] æ•´ä½“æµ‹è¯•é€šè¿‡ç‡è¾¾åˆ°95%ä»¥ä¸Š

### é£é™©ç¼“è§£

#### æ½œåœ¨é£é™©
1. **ä¿®å¤å¼•å…¥æ–°é—®é¢˜**: ä¿®å¤è¿‡ç¨‹ä¸­å¯èƒ½ç ´åç°æœ‰åŠŸèƒ½
2. **å¤–éƒ¨ä¾èµ–é—®é¢˜**: æŸäº›æµ‹è¯•å¯èƒ½ä¾èµ–å¤–éƒ¨å·¥å…·æˆ–æ•°æ®
3. **æ—¶é—´è¶…æœŸ**: å¤æ‚é—®é¢˜å¯èƒ½éœ€è¦æ›´å¤šæ—¶é—´

#### ç¼“è§£æªæ–½
1. **æ¸è¿›å¼ä¿®å¤**: æ¯æ¬¡åªä¿®å¤ä¸€ä¸ªæ–‡ä»¶ï¼Œç«‹å³éªŒè¯
2. **å¤‡ä»½æœºåˆ¶**: ä¿®å¤å‰å¤‡ä»½åŸå§‹æ–‡ä»¶
3. **Mockç­–ç•¥**: å¯¹å¤–éƒ¨ä¾èµ–ä½¿ç”¨Mockï¼Œæé«˜æµ‹è¯•ç¨³å®šæ€§

## âœ… å®ŒæˆéªŒè¯

### æœ€ç»ˆéªŒè¯æ¸…å•
- [ ] æ‰€æœ‰æµ‹è¯•æ–‡ä»¶éƒ½èƒ½æˆåŠŸåŠ è½½
- [ ] æµ‹è¯•é€šè¿‡ç‡è¾¾åˆ°95%ä»¥ä¸Š
- [ ] æ— å¯¼å…¥è·¯å¾„é”™è¯¯
- [ ] æ— è¿‡æ—¶å¼•ç”¨å’Œæ–­è¨€é”™è¯¯
- [ ] å»ºç«‹äº†è‡ªåŠ¨åŒ–è´¨é‡æ£€æŸ¥
- [ ] æ–‡æ¡£å·²æ›´æ–°

### æˆåŠŸæ ‡å‡†
å®Œæˆååº”è¯¥è¾¾åˆ°ï¼š
- **æµ‹è¯•æˆåŠŸç‡**: 95%ä»¥ä¸Š
- **ä»£ç è´¨é‡**: æ— æ˜æ˜¾æŠ€æœ¯å€ºåŠ¡
- **ç»´æŠ¤æ€§**: å»ºç«‹äº†æŒç»­è´¨é‡ä¿è¯æœºåˆ¶

---

**åˆ¶å®šæ—¶é—´**: 2025-07-25  
**é¢„è®¡å®Œæˆ**: 2025-08-01  
**è´Ÿè´£äºº**: å¼€å‘å›¢é˜Ÿ  
**å®¡æŸ¥äºº**: é¡¹ç›®è´Ÿè´£äºº
