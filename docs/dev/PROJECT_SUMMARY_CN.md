# PktMask é¡¹ç›®è§£è¯»æ€»ç»“

> **æ–‡æ¡£æ—¥æœŸ**: 2025-10-09  
> **é¡¹ç›®ç‰ˆæœ¬**: v3.1+  
> **åˆ†æèŒƒå›´**: å®Œæ•´ä»£ç åº“æ¶æ„ä¸æ•°æ®æµ

---

## ğŸ“Œ é¡¹ç›®æ¦‚è§ˆ

**PktMask** æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç½‘ç»œæ•°æ®åŒ…å®‰å…¨å¤„ç†å·¥å…·ï¼Œç”¨äºåœ¨ä¿ç•™åˆ†æä»·å€¼çš„åŒæ—¶ç§»é™¤æ•æ„Ÿä¿¡æ¯ï¼Œä½¿ç½‘ç»œä¸“ä¸šäººå‘˜èƒ½å¤Ÿå®‰å…¨åœ°å…±äº« PCAP/PCAPNG æ–‡ä»¶ã€‚

### æ ¸å¿ƒä»·å€¼ä¸»å¼ 

```
åŸå§‹ç½‘ç»œæ•è· â†’ [PktMaskå¤„ç†] â†’ å®‰å…¨å¯å…±äº«çš„æ•°æ®
  â†“                              â†“
åŒ…å«æ•æ„Ÿä¿¡æ¯                    ç§»é™¤æ•æ„Ÿä¿¡æ¯
- çœŸå®IPåœ°å€                    - åŒ¿åIPåœ°å€
- æ˜æ–‡è½½è·æ•°æ®                  - æ©ç è½½è·æ•°æ®
- é‡å¤æ•°æ®åŒ…                    - å»é‡ä¼˜åŒ–
```

---

## ğŸ¯ ä¸‰å¤§æ ¸å¿ƒåŠŸèƒ½

### 1. ğŸ”„ Remove Dupesï¼ˆæ•°æ®åŒ…å»é‡ï¼‰

**æŠ€æœ¯å®ç°**:
- ç®—æ³•: SHA256 å“ˆå¸Œå­—èŠ‚çº§å»é‡
- å®ç°ç±»: `DeduplicationStage`
- ä½ç½®: `src/pktmask/core/pipeline/stages/deduplication_stage.py`

**å¤„ç†é€»è¾‘**:
```python
for packet in pcap_file:
    hash_value = sha256(packet.raw_bytes)
    if hash_value not in seen_hashes:
        seen_hashes.add(hash_value)
        write_to_output(packet)
    else:
        skip_packet()  # é‡å¤åŒ…
```

**æ•ˆæœ**: å…¸å‹åœºæ™¯å‡å°‘ 30-50% æ–‡ä»¶å¤§å°

---

### 2. ğŸ­ Anonymize IPsï¼ˆIPåœ°å€åŒ¿ååŒ–ï¼‰

**æŠ€æœ¯å®ç°**:
- ç­–ç•¥: å±‚æ¬¡åŒ–åŒ¿ååŒ–ï¼ˆHierarchicalAnonymizationStrategyï¼‰
- å®ç°ç±»: `AnonymizationStage`
- ä½ç½®: `src/pktmask/core/pipeline/stages/anonymization_stage.py`

**å¤„ç†é€»è¾‘**:
```python
for packet in pcap_file:
    if has_ip_layer(packet):
        src_ip = extract_source_ip(packet)
        dst_ip = extract_destination_ip(packet)
        
        # åº”ç”¨åŒ¿ååŒ–ç­–ç•¥ï¼ˆä¿ç•™å­ç½‘ç»“æ„ï¼‰
        anon_src = anonymize_strategy.anonymize(src_ip)
        anon_dst = anonymize_strategy.anonymize(dst_ip)
        
        # é‡å†™IPå­—æ®µ
        packet.src = anon_src
        packet.dst = anon_dst
        recalculate_checksums(packet)
        write_to_output(packet)
```

**ç‰¹ç‚¹**:
- ä¿ç•™å­ç½‘ç»“æ„ï¼ˆä¾¿äºåˆ†æï¼‰
- ä¸€è‡´æ€§æ˜ å°„ï¼ˆåŒä¸€IPæ€»æ˜¯æ˜ å°„åˆ°åŒä¸€åŒ¿åIPï¼‰
- æ”¯æŒ IPv4 å’Œ IPv6

---

### 3. ğŸ›¡ï¸ Mask Payloadsï¼ˆè½½è·æ©ç ï¼‰

**æŠ€æœ¯å®ç°**: åŒæ¨¡å—æ¶æ„
- å®ç°ç±»: `MaskingStage`
- ä½ç½®: `src/pktmask/core/pipeline/stages/masking_stage/`

#### åŒæ¨¡å—æ¶æ„è¯¦è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MaskingStage                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Marker æ¨¡å—         â”‚    â”‚  Masker æ¨¡å—       â”‚   â”‚
â”‚  â”‚  (åè®®åˆ†æå™¨)        â”‚    â”‚  (è½½è·å¤„ç†å™¨)      â”‚   â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚  â”‚ å·¥å…·: TShark         â”‚    â”‚ å·¥å…·: Scapy        â”‚   â”‚
â”‚  â”‚ èŒè´£:                â”‚    â”‚ èŒè´£:              â”‚   â”‚
â”‚  â”‚ - è§£æåè®®ç»“æ„       â”‚    â”‚ - è¯»å–æ•°æ®åŒ…       â”‚   â”‚
â”‚  â”‚ - è¯†åˆ«ä¿ç•™éƒ¨åˆ†       â”‚    â”‚ - åº”ç”¨ä¿ç•™è§„åˆ™     â”‚   â”‚
â”‚  â”‚ - ç”Ÿæˆè§„åˆ™é›†         â”‚    â”‚ - æ©ç æ•æ„Ÿè½½è·     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚             â”‚                         â”‚               â”‚
â”‚             â””â”€â”€â”€â”€ KeepRuleSet â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                  (TCPåºåˆ—å·è§„åˆ™)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¤„ç†æµç¨‹**:

```
Phase 1: Marker åˆ†æ
  Input PCAP â†’ TShark è§£æ â†’ è¯†åˆ«åè®®å­—æ®µ â†’ ç”Ÿæˆ KeepRuleSet
  
  KeepRuleSet ç¤ºä¾‹:
  {
    tcp_seq_12345: "keep",    # ä¿ç•™ï¼ˆæ¡æ‰‹åŒ…ï¼‰
    tcp_seq_12346: "mask",    # æ©ç ï¼ˆåº”ç”¨æ•°æ®ï¼‰
    tcp_seq_12347: "keep",    # ä¿ç•™ï¼ˆAlertåŒ…ï¼‰
  }

Phase 2: Masker åº”ç”¨
  Input PCAP â†’ Scapy è¯»å– â†’ æŸ¥è¯¢è§„åˆ™é›† â†’ åº”ç”¨æ©ç  â†’ Output PCAP
  
  for packet in pcap:
      tcp_seq = packet[TCP].seq
      action = keep_rules.get(tcp_seq)
      if action == "mask":
          packet.payload = b'\x00' * len(packet.payload)
      write_to_output(packet)
```

**æ”¯æŒåè®®**:
- TLS/SSL (é»˜è®¤)
- HTTP
- Auto-detect (è‡ªåŠ¨æ£€æµ‹)

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„

PktMask é‡‡ç”¨ç»å…¸çš„åˆ†å±‚æ¶æ„ï¼Œä»ä¸Šåˆ°ä¸‹åˆ†ä¸º 5 å±‚ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·ç•Œé¢å±‚ (UI Layer)                                 â”‚
â”‚    - GUI (PyQt6): å›¾å½¢åŒ–ç•Œé¢ï¼Œå®æ—¶è¿›åº¦ï¼Œå¯è§†åŒ–æŠ¥å‘Š       â”‚
â”‚    - CLI (Typer): å‘½ä»¤è¡Œç•Œé¢ï¼Œæ‰¹å¤„ç†ï¼Œè„šæœ¬é›†æˆ           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ç»Ÿä¸€æœåŠ¡å±‚ (Service Layer)                           â”‚
â”‚    - ConfigService: é…ç½®æ„å»ºä¸éªŒè¯                       â”‚
â”‚    - PipelineService: æ‰§è¡Œå™¨ç®¡ç†                         â”‚
â”‚    - ProgressService: è¿›åº¦ç®¡ç†                           â”‚
â”‚    - OutputService: è¾“å‡ºæ ¼å¼åŒ–                           â”‚
â”‚    - ReportService: æŠ¥å‘Šç”Ÿæˆ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ ¸å¿ƒå¤„ç†å±‚ (Core Layer)                              â”‚
â”‚    - PipelineExecutor: ç»Ÿä¸€æ‰§è¡Œå¼•æ“ï¼Œé˜¶æ®µè°ƒåº¦            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å¤„ç†é˜¶æ®µå±‚ (Stage Layer)                             â”‚
â”‚    - DeduplicationStage: SHA256 å»é‡                    â”‚
â”‚    - AnonymizationStage: IP åŒ¿ååŒ–                      â”‚
â”‚    - MaskingStage: è½½è·æ©ç ï¼ˆåŒæ¨¡å—ï¼‰                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)                    â”‚
â”‚    - Logging: ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ                               â”‚
â”‚    - Error Handling: å¼‚å¸¸å¤„ç†ä¸æ¢å¤                      â”‚
â”‚    - Resource Management: èµ„æºç®¡ç†ä¸æ¸…ç†                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **ç»Ÿä¸€æ¥å£**: GUI å’Œ CLI å…±äº«ç›¸åŒçš„æ ¸å¿ƒå¤„ç†é€»è¾‘
2. **èŒè´£åˆ†ç¦»**: æ¯å±‚ä¸“æ³¨ç‰¹å®šåŠŸèƒ½ï¼Œé™ä½è€¦åˆ
3. **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°çš„å¤„ç†é˜¶æ®µå’Œåè®®
4. **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ç±»å‹æ³¨è§£ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
5. **é”™è¯¯æ¢å¤**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œèµ„æºæ¸…ç†

---

## ğŸ”„ æ•°æ®å¤„ç†æµç¨‹

### å•æ–‡ä»¶å¤„ç†æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰

```
ç”¨æˆ·è¾“å…¥
  â†“
éªŒè¯è¾“å…¥ â†’ æ„å»ºé…ç½® â†’ åˆ›å»ºæ‰§è¡Œå™¨
  â†“
æ£€æŸ¥è¾“å…¥æ–‡ä»¶ â†’ åˆ›å»ºä¸´æ—¶ç›®å½•
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 1: DeduplicationStage         â”‚
â”‚ Input â†’ è®¡ç®—å“ˆå¸Œ â†’ è¿‡æ»¤é‡å¤ â†’ Temp1 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 2: AnonymizationStage         â”‚
â”‚ Temp1 â†’ æå–IP â†’ åŒ¿ååŒ– â†’ Temp2     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Stage 3: MaskingStage               â”‚
â”‚ Temp2 â†’ Markeråˆ†æ â†’ Maskerå¤„ç†     â”‚
â”‚      â†’ Output                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†“
æ”¶é›†ç»Ÿè®¡ â†’ æ¸…ç†ä¸´æ—¶æ–‡ä»¶ â†’ ç”ŸæˆæŠ¥å‘Š
  â†“
è¾“å‡ºç»“æœ
```

### é…ç½®æ•°æ®æµè½¬

```
GUI å¤é€‰æ¡† â”€â”€â”
            â”œâ”€â”€â†’ ProcessingOptions â”€â”€â†’ PipelineConfig â”€â”€â†’ PipelineExecutor
CLI å‚æ•° â”€â”€â”€â”€â”˜

ç¤ºä¾‹:
GUI: [âœ“] Remove Dupes, [âœ“] Anonymize IPs, [âœ“] Mask Payloads
  â†“
ProcessingOptions {
  enable_remove_dupes: true,
  enable_anonymize_ips: true,
  enable_mask_payloads: true,
  mask_protocol: "tls"
}
  â†“
PipelineConfig {
  "remove_dupes": {"enabled": true},
  "anonymize_ips": {"enabled": true},
  "mask_payloads": {
    "enabled": true,
    "protocol": "tls",
    "marker_config": {...},
    "masker_config": {...}
  }
}
  â†“
PipelineExecutor åˆ›å»º 3 ä¸ª Stage å®ä¾‹å¹¶é¡ºåºæ‰§è¡Œ
```

---

## ğŸ”‘ å…³é”®ç±»ä¸æ¥å£

### 1. PipelineExecutorï¼ˆæ ¸å¿ƒæ‰§è¡Œå™¨ï¼‰

**ä½ç½®**: `src/pktmask/core/pipeline/executor.py`

**æ ¸å¿ƒæ–¹æ³•**:
```python
class PipelineExecutor:
    def __init__(self, config: Dict):
        """æ ¹æ®é…ç½®åŠ¨æ€è£…é… Stage åˆ—è¡¨"""
        self.stages = self._build_pipeline(config)
    
    def run(self, input_path, output_path, progress_cb) -> ProcessResult:
        """æ‰§è¡Œå®Œæ•´å¤„ç†ç®¡é“"""
        # 1. éªŒè¯è¾“å…¥
        # 2. åˆ›å»ºä¸´æ—¶ç›®å½•
        # 3. é¡ºåºæ‰§è¡Œå„ Stage
        # 4. èšåˆç»Ÿè®¡ä¿¡æ¯
        # 5. æ¸…ç†èµ„æº
        # 6. è¿”å›ç»“æœ
```

### 2. StageBaseï¼ˆé˜¶æ®µåŸºç±»ï¼‰

**ä½ç½®**: `src/pktmask/core/pipeline/base_stage.py`

**æ ¸å¿ƒæ¥å£**:
```python
class StageBase(ABC):
    name: str  # é˜¶æ®µåç§°
    
    @abstractmethod
    def initialize(self, config) -> bool:
        """åˆå§‹åŒ–é˜¶æ®µ"""
    
    @abstractmethod
    def process_file(self, input_path, output_path) -> StageStats:
        """å¤„ç†å•ä¸ªæ–‡ä»¶ï¼ˆæ ¸å¿ƒæ–¹æ³•ï¼‰"""
    
    # å¯é€‰çš„ç›®å½•çº§æ–¹æ³•
    def prepare_for_directory(self, directory, all_files):
        """ç›®å½•çº§é¢„å¤„ç†"""
    
    def finalize_directory_processing(self):
        """ç›®å½•çº§åå¤„ç†"""
```

### 3. ConfigServiceï¼ˆé…ç½®æœåŠ¡ï¼‰

**ä½ç½®**: `src/pktmask/services/config_service.py`

**æ ¸å¿ƒæ–¹æ³•**:
```python
class ConfigService:
    def create_options_from_gui(self, checkboxes) -> ProcessingOptions:
        """ä» GUI çŠ¶æ€åˆ›å»ºé…ç½®"""
    
    def create_options_from_cli(self, args) -> ProcessingOptions:
        """ä» CLI å‚æ•°åˆ›å»ºé…ç½®"""
    
    def build_pipeline_config(self, options) -> Dict:
        """æ„å»ºç®¡é“é…ç½®å­—å…¸"""
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹

### ProcessingOptionsï¼ˆå¤„ç†é€‰é¡¹ï¼‰

```python
@dataclass
class ProcessingOptions:
    enable_remove_dupes: bool = False
    enable_anonymize_ips: bool = False
    enable_mask_payloads: bool = False
    mask_protocol: str = "tls"
    preserve_handshake: bool = True
    preserve_alert: bool = True
    # ... æ›´å¤šé…ç½®é¡¹
```

### StageStatsï¼ˆé˜¶æ®µç»Ÿè®¡ï¼‰

```python
@dataclass
class StageStats:
    stage_name: str              # é˜¶æ®µåç§°
    packets_processed: int       # å¤„ç†çš„æ•°æ®åŒ…æ•°
    packets_modified: int        # ä¿®æ”¹çš„æ•°æ®åŒ…æ•°
    duration_ms: float           # å¤„ç†è€—æ—¶ï¼ˆæ¯«ç§’ï¼‰
    extra_metrics: Dict          # é¢å¤–æŒ‡æ ‡
```

### ProcessResultï¼ˆå¤„ç†ç»“æœï¼‰

```python
@dataclass
class ProcessResult:
    success: bool                # æ˜¯å¦æˆåŠŸ
    input_file: str              # è¾“å…¥æ–‡ä»¶è·¯å¾„
    output_file: Optional[str]   # è¾“å‡ºæ–‡ä»¶è·¯å¾„
    duration_ms: float           # æ€»è€—æ—¶
    stage_stats: List[StageStats] # å„é˜¶æ®µç»Ÿè®¡
    errors: List[str]            # é”™è¯¯åˆ—è¡¨
```

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç”¨é€” |
|------|------|
| **Python 3.8+** | ä¸»è¦ç¼–ç¨‹è¯­è¨€ |
| **Scapy** | æ•°æ®åŒ…è¯»å†™å’Œå¤„ç† |
| **PyQt6** | GUI æ¡†æ¶ |
| **Typer** | CLI æ¡†æ¶ |
| **TShark** | åè®®åˆ†æï¼ˆå¤–éƒ¨å·¥å…·ï¼‰ |
| **pytest** | æµ‹è¯•æ¡†æ¶ |

---

## ğŸ“ é¡¹ç›®ç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰

```
PktMask/
â”œâ”€â”€ src/pktmask/              # æºä»£ç 
â”‚   â”œâ”€â”€ __main__.py           # å…¥å£ç‚¹
â”‚   â”œâ”€â”€ cli/                  # CLI æ¨¡å—
â”‚   â”œâ”€â”€ gui/                  # GUI æ¨¡å—
â”‚   â”œâ”€â”€ core/                 # æ ¸å¿ƒå¤„ç†
â”‚   â”‚   â””â”€â”€ pipeline/         # ç®¡é“ç³»ç»Ÿ
â”‚   â”‚       â”œâ”€â”€ executor.py   # æ‰§è¡Œå™¨
â”‚   â”‚       â”œâ”€â”€ base_stage.py # é˜¶æ®µåŸºç±»
â”‚   â”‚       â””â”€â”€ stages/       # å¤„ç†é˜¶æ®µ
â”‚   â”œâ”€â”€ services/             # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ domain/               # é¢†åŸŸæ¨¡å‹
â”‚   â”œâ”€â”€ infrastructure/       # åŸºç¡€è®¾æ–½
â”‚   â””â”€â”€ utils/                # å·¥å…·å‡½æ•°
â”œâ”€â”€ tests/                    # æµ‹è¯•ä»£ç 
â”œâ”€â”€ docs/                     # æ–‡æ¡£
â””â”€â”€ config/                   # é…ç½®æ–‡ä»¶
```

---

## âœ¨ è®¾è®¡äº®ç‚¹

### 1. ç»Ÿä¸€çš„ GUI/CLI æ¥å£

é€šè¿‡æœåŠ¡å±‚æŠ½è±¡ï¼ŒGUI å’Œ CLI å…±äº«ç›¸åŒçš„æ ¸å¿ƒå¤„ç†é€»è¾‘ï¼Œç¡®ä¿åŠŸèƒ½ä¸€è‡´æ€§ï¼š

```
GUI â†’ ConfigService â†’ PipelineExecutor â†’ Stages
CLI â†’ ConfigService â†’ PipelineExecutor â†’ Stages
                â†‘
            ç›¸åŒçš„æ ¸å¿ƒé€»è¾‘
```

### 2. åŒæ¨¡å—æ©ç æ¶æ„

Marker å’Œ Masker åˆ†ç¦»è®¾è®¡ï¼Œå®ç°å…³æ³¨ç‚¹åˆ†ç¦»ï¼š
- **Marker**: ä¸“æ³¨åè®®åˆ†æï¼ˆTSharkï¼‰
- **Masker**: ä¸“æ³¨è½½è·å¤„ç†ï¼ˆScapyï¼‰
- **ä¼˜åŠ¿**: æ˜“äºæ‰©å±•æ–°åè®®ï¼Œç‹¬ç«‹æµ‹è¯•

### 3. èµ„æºç®¡ç†

ä½¿ç”¨ Python ä¸Šä¸‹æ–‡ç®¡ç†å™¨è‡ªåŠ¨æ¸…ç†ä¸´æ—¶æ–‡ä»¶ï¼š

```python
with tempfile.TemporaryDirectory() as temp_dir:
    # å¤„ç†é€»è¾‘
    process_pipeline(input, output, temp_dir)
    # è‡ªåŠ¨æ¸…ç†ä¸´æ—¶ç›®å½•
```

### 4. äº‹ä»¶é©±åŠ¨çš„è¿›åº¦æŠ¥å‘Š

é€šè¿‡å›è°ƒæœºåˆ¶å®ç°è§£è€¦çš„è¿›åº¦æŠ¥å‘Šï¼š

```python
def on_progress(event, data):
    if event == PipelineEvents.STAGE_END:
        update_ui(data)

executor.run(input, output, progress_callback=on_progress)
```

---

## ğŸ“ æ€»ç»“

PktMask æ˜¯ä¸€ä¸ªæ¶æ„æ¸…æ™°ã€è®¾è®¡ä¼˜è‰¯çš„ä¸“ä¸šå·¥å…·ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### æ ¸å¿ƒä¼˜åŠ¿
- âœ… **ç»Ÿä¸€æ¶æ„**: GUI/CLI å…±äº«æ ¸å¿ƒé€»è¾‘
- âœ… **æ¨¡å—åŒ–è®¾è®¡**: æ¸…æ™°çš„èŒè´£åˆ†ç¦»
- âœ… **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ç±»å‹æ³¨è§£
- âœ… **å¯æ‰©å±•æ€§**: æ˜“äºæ·»åŠ æ–°åŠŸèƒ½
- âœ… **é”™è¯¯æ¢å¤**: å®Œå–„çš„å¼‚å¸¸å¤„ç†

### æŠ€æœ¯ç‰¹è‰²
- ğŸ”§ åŒæ¨¡å—æ©ç æ¶æ„ï¼ˆMarker + Maskerï¼‰
- ğŸ”§ å±‚æ¬¡åŒ– IP åŒ¿ååŒ–ç­–ç•¥
- ğŸ”§ SHA256 å­—èŠ‚çº§å»é‡
- ğŸ”§ äº‹ä»¶é©±åŠ¨çš„è¿›åº¦æŠ¥å‘Š
- ğŸ”§ è‡ªåŠ¨èµ„æºç®¡ç†

### åº”ç”¨ä»·å€¼
- ğŸ¯ å®‰å…¨å…±äº«ç½‘ç»œæ•°æ®
- ğŸ¯ ä¿æŠ¤éšç§å’Œæ•æ„Ÿä¿¡æ¯
- ğŸ¯ æ»¡è¶³åˆè§„è¦æ±‚
- ğŸ¯ æ”¯æŒæ•…éšœæ’æŸ¥å’Œåˆ†æ

---

**æ–‡æ¡£ç”Ÿæˆ**: åŸºäºå®Œæ•´ä»£ç åº“åˆ†æ  
**å¯è§†åŒ–å›¾è¡¨**: å‚è§ Mermaid æµç¨‹å›¾ï¼ˆå·²ç”Ÿæˆï¼‰  
**è¯¦ç»†æ–‡æ¡£**: `docs/dev/PROJECT_ANALYSIS_AND_FLOW.md`

