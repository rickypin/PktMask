# PktMask 问题修复检查清单

> **用途**: 跟踪问题修复进度  
> **更新日期**: 2025-10-09  
> **状态图例**: ❌ 未修复 | 🔄 进行中 | ✅ 已修复

---

## 🔴 严重问题 (Critical) - P0/P1

### P0 - 立即修复 (本周内)

- [ ] **#1 移除未使用的依赖**
  - [ ] 从 `pyproject.toml` 移除 `fastapi>=0.110.0`
  - [ ] 从 `pyproject.toml` 移除 `uvicorn>=0.27.0`
  - [ ] 从 `pyproject.toml` 移除 `networkx>=3.0.0`
  - [ ] 从 `pyproject.toml` 移除 `pyshark>=0.6`
  - [ ] 从 `pyproject.toml` 移除 `watchdog>=3.0.0`
  - [ ] 运行 `pip install -e .` 验证
  - [ ] 更新 README 依赖说明
  - **预计时间**: 2小时
  - **负责人**: _______
  - **完成日期**: _______

- [ ] **#2 添加 TShark 调用超时和资源限制**
  - [ ] 修改 `src/pktmask/utils/subprocess_utils.py`
    - [ ] `run_tshark_command` 默认超时改为 60秒
    - [ ] 添加内存限制参数
  - [ ] 修改 `src/pktmask/tools/tls23_marker.py`
    - [ ] 所有 TShark 调用添加 `timeout=60`
  - [ ] 修改 `src/pktmask/tools/enhanced_tls_marker.py`
    - [ ] 所有 TShark 调用添加 `timeout=60`
  - [ ] 添加超时异常处理
  - [ ] 添加单元测试验证超时机制
  - **预计时间**: 3小时
  - **负责人**: _______
  - **完成日期**: _______

- [ ] **#3 修复临时文件清理机制**
  - [ ] 创建 `TempFileManager` 类
  - [ ] 实现 `atexit` 清理钩子
  - [ ] 修改 `PipelineExecutor` 使用新管理器
  - [ ] 添加异常情况下的清理保证
  - [ ] 添加清理失败的日志记录
  - [ ] 测试进程被 kill 时的清理
  - **预计时间**: 3小时
  - **负责人**: _______
  - **完成日期**: _______

- [ ] **#4 移除硬编码的调试日志级别**
  - [ ] 删除 `src/pktmask/__main__.py` 中的 TEMP 代码块
  - [ ] 确保日志级别由配置文件控制
  - [ ] 验证生产环境日志输出正常
  - **预计时间**: 30分钟
  - **负责人**: _______
  - **完成日期**: _______

### P1 - 短期修复 (1-2周)

- [ ] **#5 简化错误处理系统**
  - [ ] 分析实际使用的错误处理功能
  - [ ] 移除未使用的恢复策略
  - [ ] 简化装饰器实现
  - [ ] 保留核心异常类型（5-6个）
  - [ ] 更新文档
  - [ ] 代码量目标: 从 2000行 减少到 800行
  - **预计时间**: 3天
  - **负责人**: _______
  - **完成日期**: _______

- [ ] **#6 合并重复的配置系统**
  - [ ] 选择保留 `src/pktmask/config/` 或 `config/app/`
  - [ ] 迁移配置到单一位置
  - [ ] 删除重复的配置类
  - [ ] 更新所有导入引用
  - [ ] 添加配置验证
  - [ ] 更新文档
  - **预计时间**: 2天
  - **负责人**: _______
  - **完成日期**: _______

- [ ] **#7 优化 Scapy 使用方式**
  - [ ] 替换 `rdpcap` 为 `PcapReader`
  - [ ] 替换 `wrpcap` 为 `PcapWriter`
  - [ ] 实现流式处理
  - [ ] 添加内存使用监控
  - [ ] 性能测试: 100MB 文件内存使用 <200MB
  - **预计时间**: 2天
  - **负责人**: _______
  - **完成日期**: _______

- [ ] **#8 添加核心逻辑单元测试**
  - [ ] `MaskingStage` 单元测试
    - [ ] 测试 TLS 握手保留
    - [ ] 测试应用数据掩码
    - [ ] 测试边界条件
  - [ ] `AnonymizationStage` 单元测试
    - [ ] 测试子网保留
    - [ ] 测试一致性映射
    - [ ] 测试 IPv4/IPv6
  - [ ] `DeduplicationStage` 单元测试
    - [ ] 测试哈希去重
    - [ ] 测试重复检测
  - [ ] 目标覆盖率: 70%
  - **预计时间**: 5天
  - **负责人**: _______
  - **完成日期**: _______

---

## 🟡 重要问题 (Major) - P2

### 性能相关

- [ ] **#9 实现真正的并发处理**
  - [ ] 设计并发处理架构
  - [ ] 实现 `ProcessPoolExecutor` 集成
  - [ ] 添加进度聚合机制
  - [ ] 处理并发异常
  - [ ] 性能测试: 4核CPU提升4倍速度
  - **预计时间**: 2周
  - **负责人**: _______
  - **完成日期**: _______

- [ ] **#10 优化内存使用**
  - [ ] 使用生成器模式
  - [ ] 及时释放大对象
  - [ ] 添加内存监控
  - [ ] 内存泄漏检测
  - **预计时间**: 1周
  - **负责人**: _______
  - **完成日期**: _______

- [ ] **#11 实现性能监控**
  - [ ] 添加性能指标收集
  - [ ] 实现性能报告
  - [ ] 建立性能基准
  - [ ] 添加性能回归测试
  - **预计时间**: 1周
  - **负责人**: _______
  - **完成日期**: _______

### 安全相关

- [ ] **#12 添加输入验证层**
  - [ ] 实现路径验证函数
  - [ ] 防止路径遍历攻击
  - [ ] 验证 TShark 参数
  - [ ] 清理用户输入
  - [ ] 添加安全测试
  - **预计时间**: 1周
  - **负责人**: _______
  - **完成日期**: _______

- [ ] **#13 修复命令注入风险**
  - [ ] 审查所有 `subprocess` 调用
  - [ ] 移除 `shell=True`
  - [ ] 验证所有外部命令参数
  - [ ] 添加参数白名单
  - **预计时间**: 2天
  - **负责人**: _______
  - **完成日期**: _______

- [ ] **#14 防止敏感信息泄漏**
  - [ ] 审查所有日志输出
  - [ ] 移除敏感信息记录
  - [ ] 实现日志脱敏
  - **预计时间**: 1天
  - **负责人**: _______
  - **完成日期**: _______

### GUI 相关

- [ ] **#15 优化 GUI 线程模型**
  - [ ] 使用 `QThreadPool` 替代自定义线程
  - [ ] 简化信号/槽连接
  - [ ] 添加线程安全保证
  - [ ] 修复信号/槽未断开问题
  - **预计时间**: 1周
  - **负责人**: _______
  - **完成日期**: _______

- [ ] **#16 修复 GUI 线程更新 UI 问题**
  - [ ] 审查所有 UI 更新代码
  - [ ] 确保只在主线程更新 UI
  - [ ] 使用信号/槽机制
  - **预计时间**: 2天
  - **负责人**: _______
  - **完成日期**: _______

### 代码质量

- [ ] **#17 建立代码质量流程**
  - [ ] 配置 `pre-commit` hooks
  - [ ] 集成 `black` 自动格式化
  - [ ] 集成 `flake8` 代码检查
  - [ ] 集成 `mypy` 类型检查
  - [ ] 配置 CI/CD 运行检查
  - **预计时间**: 2天
  - **负责人**: _______
  - **完成日期**: _______

- [ ] **#18 完善类型注解**
  - [ ] 为所有公共函数添加类型注解
  - [ ] 为所有类属性添加类型注解
  - [ ] 运行 `mypy` 检查
  - [ ] 目标: 90% 类型注解覆盖率
  - **预计时间**: 1周
  - **负责人**: _______
  - **完成日期**: _______

- [ ] **#19 统一代码风格**
  - [ ] 运行 `black` 格式化所有代码
  - [ ] 统一导入顺序（使用 `isort`）
  - [ ] 统一引号使用（双引号）
  - [ ] 修复行长度问题
  - **预计时间**: 1天
  - **负责人**: _______
  - **完成日期**: _______

### 文档相关

- [ ] **#20 更新文档和示例**
  - [ ] 修复 `docs/api/README.md` 中的过时示例
  - [ ] 更新 API 文档
  - [ ] 添加可运行的代码示例
  - [ ] 使用 `doctest` 验证示例
  - **预计时间**: 1周
  - **负责人**: _______
  - **完成日期**: _______

---

## 🟢 次要问题 (Minor) - P3

### 代码规范

- [ ] **#21 统一变量命名**
  - [ ] 统一使用下划线命名
  - [ ] 统一缩写（`pkt` vs `packet`）
  - [ ] 定义常量替代魔法数字

- [ ] **#22 函数分解**
  - [ ] 分解超过 50 行的函数
  - [ ] 遵循单一职责原则
  - [ ] 提取重复代码

- [ ] **#23 消除代码重复**
  - [ ] 提取公共配置加载逻辑
  - [ ] 提取公共文件验证逻辑
  - [ ] 提取公共错误处理模式

### 国际化

- [ ] **#24 代码国际化**
  - [ ] 移除中文注释
  - [ ] 统一使用英文注释
  - [ ] 添加 i18n 框架支持

### 测试

- [ ] **#25 添加边界条件测试**
  - [ ] 空文件测试
  - [ ] 超大文件测试
  - [ ] 损坏文件测试
  - [ ] 并发访问测试

- [ ] **#26 改进测试质量**
  - [ ] 使用 fixture 替代真实文件
  - [ ] 添加 mock 隔离外部依赖
  - [ ] 提高测试覆盖率到 85%

### 其他

- [ ] **#27 添加 CHANGELOG**
  - [ ] 创建 `CHANGELOG.md`
  - [ ] 记录版本变更
  - [ ] 遵循语义化版本

- [ ] **#28 添加贡献指南**
  - [ ] 创建 `CONTRIBUTING.md`
  - [ ] 说明开发环境搭建
  - [ ] 说明代码审查流程

- [ ] **#29 改进错误消息**
  - [ ] 使用用户友好的错误消息
  - [ ] 提供解决建议
  - [ ] 添加错误代码

- [ ] **#30 添加性能基准测试**
  - [ ] 建立性能基准数据
  - [ ] 添加性能回归测试
  - [ ] 持续监控性能

---

## 📊 进度跟踪

### 总体进度

| 优先级 | 总数 | 已完成 | 进行中 | 未开始 | 完成率 |
|--------|------|--------|--------|--------|--------|
| P0 (严重) | 4 | 0 | 0 | 4 | 0% |
| P1 (严重) | 4 | 0 | 0 | 4 | 0% |
| P2 (重要) | 12 | 0 | 0 | 12 | 0% |
| P3 (次要) | 10 | 0 | 0 | 10 | 0% |
| **总计** | **30** | **0** | **0** | **30** | **0%** |

### 里程碑

- [ ] **里程碑 1**: P0 问题全部修复 (目标: 1周内)
- [ ] **里程碑 2**: P1 问题全部修复 (目标: 3周内)
- [ ] **里程碑 3**: P2 问题全部修复 (目标: 2月内)
- [ ] **里程碑 4**: P3 问题全部修复 (目标: 3月内)

---

## 📝 使用说明

### 如何使用此检查清单

1. **分配任务**: 在每个任务的"负责人"栏填写负责人姓名
2. **设置截止日期**: 在"完成日期"栏填写预计完成日期
3. **跟踪进度**: 完成子任务时勾选对应的复选框
4. **更新状态**: 定期更新"进度跟踪"表格
5. **记录问题**: 在修复过程中遇到的问题记录在任务下方

### 优先级说明

- **P0**: 严重影响功能或安全，必须立即修复
- **P1**: 重要问题，短期内必须修复
- **P2**: 重要改进，中期内完成
- **P3**: 次要优化，长期规划

### 验收标准

每个问题修复后需要：
1. ✅ 代码审查通过
2. ✅ 单元测试通过
3. ✅ 集成测试通过
4. ✅ 文档已更新
5. ✅ 变更已记录

---

**创建日期**: 2025-10-09  
**最后更新**: 2025-10-09  
**维护人**: _______

