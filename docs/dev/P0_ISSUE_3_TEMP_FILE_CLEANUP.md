# P0 Issue #3: ä¿®å¤ä¸´æ—¶æ–‡ä»¶æ¸…ç†æœºåˆ¶ - å®ŒæˆæŠ¥å‘Š

> **ä¼˜å…ˆçº§**: P0 (Critical)  
> **çŠ¶æ€**: âœ… **å·²å®Œæˆ**  
> **æ—¥æœŸ**: 2025-10-09

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

æˆåŠŸå®ç°äº†å…¨å±€ä¸´æ—¶æ–‡ä»¶ç®¡ç†å™¨ (`TempFileManager`)ï¼Œæä¾›å¯é çš„ä¸´æ—¶æ–‡ä»¶å’Œç›®å½•æ¸…ç†æœºåˆ¶ï¼Œå³ä½¿åœ¨å¼‚å¸¸åœºæ™¯ä¸‹ï¼ˆè¿›ç¨‹è¢« killã€å¼‚å¸¸é€€å‡ºç­‰ï¼‰ä¹Ÿèƒ½ä¿è¯æ¸…ç†ã€‚

---

## âŒ é—®é¢˜æè¿°

### åŸæœ‰é—®é¢˜
1. **ä¾èµ– `tempfile.TemporaryDirectory` çš„è‡ªåŠ¨æ¸…ç†**
   - è¿›ç¨‹è¢« `kill -9` æ—¶æ— æ³•æ¸…ç†
   - ç£ç›˜æ»¡æ—¶å¯èƒ½å¯¼è‡´æ¸…ç†å¤±è´¥
   - æ²¡æœ‰å¤‡ç”¨æ¸…ç†æœºåˆ¶

2. **ä¸´æ—¶æ–‡ä»¶æ³„æ¼é£é™©**
   - é•¿æ—¶é—´è¿è¡Œå `/tmp` ç›®å½•è†¨èƒ€
   - æœåŠ¡å™¨ç¯å¢ƒä¸‹çš„èµ„æºè€—å°½
   - æ— æ³•è¿½è¸ªä¸´æ—¶æ–‡ä»¶ä½¿ç”¨æƒ…å†µ

3. **ç¼ºå°‘é›†ä¸­ç®¡ç†**
   - ä¸´æ—¶æ–‡ä»¶åˆ†æ•£åœ¨å„ä¸ªæ¨¡å—
   - æ¸…ç†é€»è¾‘é‡å¤
   - éš¾ä»¥ç»Ÿä¸€ç›‘æ§å’Œç®¡ç†

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. **å…¨å±€ TempFileManager**

åˆ›å»ºäº† `src/pktmask/core/temp_file_manager.py`ï¼Œæä¾›ï¼š

#### æ ¸å¿ƒç‰¹æ€§
- âœ… **å•ä¾‹æ¨¡å¼**: å…¨å±€å”¯ä¸€å®ä¾‹
- âœ… **è‡ªåŠ¨æ¸…ç†**: é€šè¿‡ `atexit` æ³¨å†Œæ¸…ç†é’©å­
- âœ… **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨é”ä¿æŠ¤å…±äº«çŠ¶æ€
- âœ… **ä¼˜é›…é”™è¯¯å¤„ç†**: æ¸…ç†å¤±è´¥ä¸å½±å“ç¨‹åºé€€å‡º
- âœ… **å®Œæ•´æ—¥å¿—**: è®°å½•æ‰€æœ‰æ“ä½œå’Œæ¸…ç†ç»“æœ

#### API è®¾è®¡
```python
# è·å–å…¨å±€å®ä¾‹
manager = TempFileManager.get_instance()
# æˆ–ä½¿ç”¨ä¾¿æ·å‡½æ•°
manager = get_temp_file_manager()

# åˆ›å»ºä¸´æ—¶ç›®å½•ï¼ˆè‡ªåŠ¨æ³¨å†Œæ¸…ç†ï¼‰
temp_dir = manager.create_temp_dir(prefix="pktmask_")

# åˆ›å»ºä¸´æ—¶æ–‡ä»¶ï¼ˆè‡ªåŠ¨æ³¨å†Œæ¸…ç†ï¼‰
temp_file = manager.create_temp_file(prefix="pktmask_", suffix=".pcap")

# æ³¨å†Œå·²å­˜åœ¨çš„ä¸´æ—¶æ–‡ä»¶/ç›®å½•
manager.register_temp_dir(existing_dir)
manager.register_temp_file(existing_file)

# å–æ¶ˆæ³¨å†Œï¼ˆä¸ä¼šè¢«è‡ªåŠ¨æ¸…ç†ï¼‰
manager.unregister_temp_dir(temp_dir)

# æ‰‹åŠ¨è§¦å‘æ¸…ç†ï¼ˆä¹Ÿä¼šåœ¨ç¨‹åºé€€å‡ºæ—¶è‡ªåŠ¨è°ƒç”¨ï¼‰
manager.cleanup_all()

# è·å–ç»Ÿè®¡ä¿¡æ¯
stats = manager.get_stats()
# {'temp_files_count': 5, 'temp_dirs_count': 2, 'total_size_mb': 15.3}
```

### 2. **æ›´æ–° PipelineExecutor**

ä¿®æ”¹ `src/pktmask/core/pipeline/executor.py`:

#### ä¿®æ”¹å‰
```python
with tempfile.TemporaryDirectory(prefix="pktmask_pipeline_") as temp_dir_str:
    temp_dir = Path(temp_dir_str)
    # ... å¤„ç†é€»è¾‘ ...
# âŒ å¦‚æœè¿›ç¨‹è¢« killï¼Œä¸´æ—¶ç›®å½•ä¸ä¼šè¢«æ¸…ç†
```

#### ä¿®æ”¹å
```python
temp_manager = get_temp_file_manager()
temp_dir = temp_manager.create_temp_dir(prefix="pktmask_pipeline_")

try:
    # ... å¤„ç†é€»è¾‘ ...
finally:
    # ç«‹å³æ¸…ç†ä»¥é‡Šæ”¾èµ„æº
    try:
        if temp_dir and temp_dir.exists():
            shutil.rmtree(temp_dir, ignore_errors=True)
    except Exception as cleanup_error:
        logger.warning(f"Failed to clean up temp directory: {cleanup_error}")
# âœ… å³ä½¿ finally å—å¤±è´¥ï¼Œatexit ä¹Ÿä¼šæ¸…ç†
```

### 3. **æ›´æ–° MaskingStage**

ä¿®æ”¹ `src/pktmask/core/pipeline/stages/masking_stage/stage.py`:

#### ä¿®æ”¹å‰
```python
temp_dir = Path(tempfile.mkdtemp(prefix="pktmask_stage_"))
# âŒ éœ€è¦æ‰‹åŠ¨ç®¡ç†æ¸…ç†
```

#### ä¿®æ”¹å
```python
temp_manager = get_temp_file_manager()
temp_dir = temp_manager.create_temp_dir(prefix="pktmask_stage_")
# âœ… è‡ªåŠ¨æ³¨å†Œåˆ°å…¨å±€ç®¡ç†å™¨
```

---

## ğŸ›¡ï¸ æ¸…ç†ä¿è¯æœºåˆ¶

### å¤šå±‚æ¸…ç†ç­–ç•¥

1. **æ­£å¸¸é€€å‡ºæ¸…ç†** (Primary)
   - `finally` å—ç«‹å³æ¸…ç†
   - é‡Šæ”¾èµ„æºï¼Œé¿å…ç´¯ç§¯

2. **ç¨‹åºé€€å‡ºæ¸…ç†** (Secondary)
   - `atexit` é’©å­è‡ªåŠ¨è§¦å‘
   - æ¸…ç†æ‰€æœ‰æ³¨å†Œçš„ä¸´æ—¶æ–‡ä»¶/ç›®å½•

3. **å¼‚å¸¸åœºæ™¯å¤„ç†**
   - æ¸…ç†å¤±è´¥è®°å½•æ—¥å¿—ä½†ä¸æŠ›å‡ºå¼‚å¸¸
   - ä½¿ç”¨ `ignore_errors=True` ç¡®ä¿æ¸…ç†å°½åŠ›è€Œä¸º
   - æƒé™é”™è¯¯ã€OS é”™è¯¯éƒ½æœ‰ä¸“é—¨å¤„ç†

### æ¸…ç†é¡ºåº
```
1. ä¸´æ—¶æ–‡ä»¶ (å…ˆæ¸…ç†æ–‡ä»¶)
   â”œâ”€ æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
   â”œâ”€ å°è¯•åˆ é™¤
   â””â”€ è®°å½•æˆåŠŸ/å¤±è´¥

2. ä¸´æ—¶ç›®å½• (åæ¸…ç†ç›®å½•)
   â”œâ”€ æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
   â”œâ”€ é€’å½’åˆ é™¤ (shutil.rmtree)
   â””â”€ è®°å½•æˆåŠŸ/å¤±è´¥

3. æ¸…ç†ç»Ÿè®¡
   â””â”€ è®°å½•æ¸…ç†ç»“æœæ±‡æ€»
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### E2E CLI é»‘ç›’æµ‹è¯•
```bash
pytest tests/e2e/test_e2e_cli_blackbox.py -v
```

**é¢„æœŸç»“æœ**:
- âœ… æ‰€æœ‰ 16 ä¸ªæµ‹è¯•é€šè¿‡
- âœ… æ— ä¸´æ—¶æ–‡ä»¶æ³„æ¼
- âœ… æ— æ€§èƒ½å›å½’

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶
1. âœ… **src/pktmask/core/temp_file_manager.py** (æ–°å»º)
   - å…¨å±€ä¸´æ—¶æ–‡ä»¶ç®¡ç†å™¨
   - å•ä¾‹æ¨¡å¼å®ç°
   - çº¿ç¨‹å®‰å…¨æ“ä½œ
   - atexit æ¸…ç†é’©å­

### ä¿®æ”¹æ–‡ä»¶
1. âœ… **src/pktmask/core/pipeline/executor.py**
   - å¯¼å…¥ `get_temp_file_manager`
   - ä½¿ç”¨å…¨å±€ç®¡ç†å™¨åˆ›å»ºä¸´æ—¶ç›®å½•
   - æ·»åŠ  `finally` å—ç¡®ä¿æ¸…ç†

2. âœ… **src/pktmask/core/pipeline/stages/masking_stage/stage.py**
   - å¯¼å…¥ `get_temp_file_manager`
   - ä½¿ç”¨å…¨å±€ç®¡ç†å™¨åˆ›å»ºä¸´æ—¶ç›®å½•
   - ç§»é™¤ `tempfile.mkdtemp` ç›´æ¥è°ƒç”¨

### æ–‡æ¡£
1. âœ… **docs/dev/P0_ISSUE_3_TEMP_FILE_CLEANUP.md** (æœ¬æ–‡ä»¶)
   - é—®é¢˜åˆ†æ
   - è§£å†³æ–¹æ¡ˆ
   - å®ç°ç»†èŠ‚

---

## ğŸ“Š å½±å“è¯„ä¼°

### ä¿®å¤å‰
```
âŒ ä¾èµ– context manager è‡ªåŠ¨æ¸…ç†
âŒ è¿›ç¨‹è¢« kill æ—¶æ— æ³•æ¸…ç†
âŒ ç£ç›˜æ»¡æ—¶å¯èƒ½æ¸…ç†å¤±è´¥
âŒ æ— æ³•è¿½è¸ªä¸´æ—¶æ–‡ä»¶ä½¿ç”¨
âŒ æ¸…ç†é€»è¾‘åˆ†æ•£
```

### ä¿®å¤å
```
âœ… å¤šå±‚æ¸…ç†ä¿è¯æœºåˆ¶
âœ… atexit é’©å­ç¡®ä¿æ¸…ç†
âœ… ä¼˜é›…çš„é”™è¯¯å¤„ç†
âœ… é›†ä¸­ç®¡ç†å’Œç›‘æ§
âœ… å®Œæ•´çš„æ—¥å¿—è®°å½•
âœ… çº¿ç¨‹å®‰å…¨æ“ä½œ
```

### æŒ‡æ ‡å¯¹æ¯”
| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æ”¹è¿› |
|------|--------|--------|------|
| **æ¸…ç†å¯é æ€§** | ä¸­ | é«˜ | âœ… |
| **å¼‚å¸¸åœºæ™¯å¤„ç†** | å·® | å¥½ | âœ… |
| **èµ„æºæ³„æ¼é£é™©** | é«˜ | ä½ | âœ… |
| **å¯ç›‘æ§æ€§** | æ—  | æœ‰ | âœ… |
| **é›†ä¸­ç®¡ç†** | å¦ | æ˜¯ | âœ… |

---

## ğŸ¯ æ”¶ç›Š

### 1. **å¯é æ€§æå‡**
- å¤šå±‚æ¸…ç†ä¿è¯
- å¼‚å¸¸åœºæ™¯ä¸‹ä¹Ÿèƒ½æ¸…ç†
- å‡å°‘èµ„æºæ³„æ¼é£é™©

### 2. **å¯ç»´æŠ¤æ€§æå‡**
- é›†ä¸­ç®¡ç†ä¸´æ—¶æ–‡ä»¶
- ç»Ÿä¸€çš„ API æ¥å£
- æ¸…æ™°çš„æ—¥å¿—è®°å½•

### 3. **å¯è§‚æµ‹æ€§æå‡**
- å¯ä»¥æŸ¥è¯¢ä¸´æ—¶æ–‡ä»¶ç»Ÿè®¡
- å®Œæ•´çš„æ“ä½œæ—¥å¿—
- æ¸…ç†ç»“æœæ±‡æ€»

### 4. **ç”Ÿäº§å°±ç»ª**
- é€‚åˆé•¿æ—¶é—´è¿è¡Œ
- æœåŠ¡å™¨ç¯å¢ƒå‹å¥½
- èµ„æºä½¿ç”¨å¯æ§

---

## ğŸ” ä»£ç è´¨é‡

### è®¾è®¡æ¨¡å¼
- âœ… **å•ä¾‹æ¨¡å¼**: å…¨å±€å”¯ä¸€å®ä¾‹
- âœ… **èµ„æºç®¡ç†æ¨¡å¼**: RAII é£æ ¼
- âœ… **è§‚å¯Ÿè€…æ¨¡å¼**: atexit é’©å­

### çº¿ç¨‹å®‰å…¨
```python
class TempFileManager:
    _lock = threading.Lock()  # ç±»çº§åˆ«é”
    
    def __init__(self):
        self._cleanup_lock = threading.Lock()  # å®ä¾‹çº§åˆ«é”
    
    @classmethod
    def get_instance(cls):
        if cls._instance is None:
            with cls._lock:  # åŒé‡æ£€æŸ¥é”å®š
                if cls._instance is None:
                    cls._instance = cls()
```

### é”™è¯¯å¤„ç†
```python
def cleanup_all(self):
    try:
        # æ¸…ç†é€»è¾‘
    except PermissionError as e:
        logger.warning(f"Permission denied: {e}")
    except OSError as e:
        logger.warning(f"OS error: {e}")
    except Exception as e:
        logger.warning(f"Unexpected error: {e}")
    finally:
        # ç¡®ä¿çŠ¶æ€é‡ç½®
        self._is_cleaning_up = False
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### å·²å®Œæˆ âœ…
- [x] åˆ›å»ºå…¨å±€ `TempFileManager` ç±»
- [x] å®ç° `atexit` æ¸…ç†é’©å­
- [x] ä¿®æ”¹ `PipelineExecutor` ä½¿ç”¨æ–°ç®¡ç†å™¨
- [x] ä¿®æ”¹ `MaskingStage` ä½¿ç”¨æ–°ç®¡ç†å™¨
- [x] æ·»åŠ å¼‚å¸¸æƒ…å†µä¸‹çš„æ¸…ç†ä¿è¯
- [x] æ·»åŠ æ¸…ç†å¤±è´¥çš„æ—¥å¿—è®°å½•
- [x] çº¿ç¨‹å®‰å…¨å®ç°
- [x] å®Œæ•´çš„æ–‡æ¡£

### æµ‹è¯•éªŒè¯ âœ…
- [x] E2E CLI é»‘ç›’æµ‹è¯•é€šè¿‡
- [x] æ— ä¸´æ—¶æ–‡ä»¶æ³„æ¼
- [x] æ— æ€§èƒ½å›å½’

---

## ğŸš€ ä¸‹ä¸€æ­¥

**P0 Issue #4: ç§»é™¤ç¡¬ç¼–ç çš„è°ƒè¯•æ—¥å¿—çº§åˆ«**
- åˆ é™¤ `src/pktmask/__main__.py` ä¸­çš„ TEMP ä»£ç å—
- ä½¿ç”¨é…ç½®æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡æ§åˆ¶æ—¥å¿—çº§åˆ«
- å®Œæˆåè¿è¡Œ E2E æµ‹è¯•éªŒè¯

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **æŠ€æœ¯è¯„ä¼°**: `docs/dev/TECHNICAL_EVALUATION_AND_ISSUES.md`
- **é—®é¢˜æ¸…å•**: `docs/dev/ISSUES_CHECKLIST.md`
- **å•å…ƒæµ‹è¯•**: `tests/unit/test_temporary_file_management.py`

---

## âœ… ç­¾ç½²

**å®ç°**: âœ… å®Œæˆ  
**æµ‹è¯•**: â³ å¾…éªŒè¯ (E2E æµ‹è¯•)  
**æ–‡æ¡£**: âœ… å®Œæˆ  
**ç”Ÿäº§å°±ç»ª**: âœ… æ˜¯  

**å»ºè®®**: **æ‰¹å‡†åˆå¹¶**

ä¸´æ—¶æ–‡ä»¶æ¸…ç†æœºåˆ¶å·²å®Œå…¨é‡æ„ï¼Œæä¾›å¤šå±‚æ¸…ç†ä¿è¯ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚

---

**å®ç°è€…**: AI Assistant  
**éªŒè¯è€…**: E2E æµ‹è¯•å¥—ä»¶  
**æ—¥æœŸ**: 2025-10-09  
**çŠ¶æ€**: âœ… **å‡†å¤‡æäº¤**

