# PktMask é¡¹ç›®ä»£ç é€»è¾‘ä¸æ¶æ„åˆ†æ

## ğŸ“‹ ç›®å½•
- [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
- [æ ¸å¿ƒåŠŸèƒ½](#æ ¸å¿ƒåŠŸèƒ½)
- [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
- [æ•°æ®å¤„ç†æµç¨‹](#æ•°æ®å¤„ç†æµç¨‹)
- [å…³é”®æ¨¡å—è§£æ](#å…³é”®æ¨¡å—è§£æ)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)

---

## é¡¹ç›®æ¦‚è¿°

**PktMask** æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç½‘ç»œæ•°æ®åŒ…å¤„ç†å·¥å…·ï¼Œç”¨äºå®‰å…¨åœ°å…±äº«å’Œåˆ†æç½‘ç»œæ•°æ®åŒ…æ•è·æ–‡ä»¶ï¼ˆPCAP/PCAPNGï¼‰ã€‚å®ƒé€šè¿‡å»é™¤æ•æ„Ÿä¿¡æ¯ï¼ŒåŒæ—¶ä¿ç•™åˆ†æä»·å€¼ï¼Œä½¿ç½‘ç»œä¸“ä¸šäººå‘˜èƒ½å¤Ÿå®‰å…¨åœ°å…±äº«ç½‘ç»œæ•°æ®ã€‚

### åº”ç”¨åœºæ™¯
- ğŸ”’ **å®‰å…¨äº‹ä»¶å“åº”** - ä¸å¤–éƒ¨å›¢é˜Ÿå…±äº«æ”»å‡»è¯æ®
- ğŸ”§ **ç½‘ç»œæ•…éšœæ’æŸ¥** - å‘ä¾›åº”å•†å‘é€ç½‘ç»œæ•è·æ•°æ®
- ğŸ“š **åŸ¹è®­ä¸ç ”ç©¶** - åˆ›å»ºçœŸå®ä½†åŒ¿åçš„æ•°æ®é›†
- âœ… **åˆè§„å®¡è®¡** - æ»¡è¶³æ•°æ®ä¿æŠ¤æ³•è§„è¦æ±‚

---

## æ ¸å¿ƒåŠŸèƒ½

PktMask æä¾›ä¸‰å¤§æ ¸å¿ƒå¤„ç†åŠŸèƒ½ï¼š

### 1. ğŸ”„ Remove Dupesï¼ˆå»é‡ï¼‰
- **åŠŸèƒ½**ï¼šæ¶ˆé™¤é‡å¤æ•°æ®åŒ…ï¼Œå‡å°‘æ–‡ä»¶å¤§å°
- **ç®—æ³•**ï¼šåŸºäº SHA256/MD5 å“ˆå¸Œçš„å­—èŠ‚çº§å»é‡
- **æ•ˆæœ**ï¼šå…¸å‹åœºæ™¯ä¸‹å¯å‡å°‘ 30-50% æ–‡ä»¶å¤§å°
- **å®ç°**ï¼š`DeduplicationStage`

### 2. ğŸ­ Anonymize IPsï¼ˆIPåŒ¿ååŒ–ï¼‰
- **åŠŸèƒ½**ï¼šå°†çœŸå®IPåœ°å€æ›¿æ¢ä¸ºä¸€è‡´çš„è™šå‡åœ°å€
- **ç­–ç•¥**ï¼šå±‚æ¬¡åŒ–åŒ¿ååŒ–ï¼Œä¿ç•™å­ç½‘ç»“æ„
- **æ”¯æŒ**ï¼šIPv4 å’Œ IPv6
- **å®ç°**ï¼š`AnonymizationStage`

### 3. ğŸ›¡ï¸ Mask Payloadsï¼ˆè½½è·æ©ç ï¼‰
- **åŠŸèƒ½**ï¼šç§»é™¤æ•æ„Ÿæ•°æ®ï¼Œä¿ç•™åè®®ç»“æ„
- **åè®®**ï¼šTLS/SSLã€HTTPï¼ˆè‡ªåŠ¨æ£€æµ‹ï¼‰
- **æ¨¡å¼**ï¼šåŒæ¨¡å—æ¶æ„ï¼ˆMarker + Maskerï¼‰
- **å®ç°**ï¼š`MaskingStage`

---

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·ç•Œé¢å±‚ (UI Layer)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         GUI             â”‚            CLI                    â”‚
â”‚   (PyQt6 æ¡Œé¢åº”ç”¨)       â”‚      (Typer å‘½ä»¤è¡Œ)               â”‚
â”‚   - å›¾å½¢åŒ–äº¤äº’           â”‚   - æ‰¹å¤„ç†æ“ä½œ                     â”‚
â”‚   - å®æ—¶è¿›åº¦æ˜¾ç¤º         â”‚   - è„šæœ¬åŒ–å¤„ç†                     â”‚
â”‚   - å¯è§†åŒ–æŠ¥å‘Š           â”‚   - è‡ªåŠ¨åŒ–é›†æˆ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç»Ÿä¸€æœåŠ¡å±‚ (Service Layer)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ConfigService     â”‚  PipelineService  â”‚  ProgressService   â”‚
â”‚  - é…ç½®æ„å»º         â”‚  - æ‰§è¡Œå™¨ç®¡ç†      â”‚  - è¿›åº¦ç®¡ç†        â”‚
â”‚  - å‚æ•°éªŒè¯         â”‚  - æ–‡ä»¶/ç›®å½•å¤„ç†   â”‚  - å›è°ƒåè°ƒ        â”‚
â”‚  - GUI/CLIé€‚é…     â”‚  - é”™è¯¯å¤„ç†        â”‚  - çŠ¶æ€è·Ÿè¸ª        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  OutputService     â”‚  ReportService    â”‚                    â”‚
â”‚  - è¾“å‡ºæ ¼å¼åŒ–       â”‚  - æŠ¥å‘Šç”Ÿæˆ        â”‚                    â”‚
â”‚  - å¤šçº§è¯¦ç»†åº¦       â”‚  - å¤šæ ¼å¼å¯¼å‡º      â”‚                    â”‚
â”‚  - æ–‡æœ¬/JSON       â”‚  - ç»Ÿè®¡èšåˆ        â”‚                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 æ ¸å¿ƒå¤„ç†å±‚ (Core Layer)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                   PipelineExecutor                          â”‚
â”‚                   - ç»Ÿä¸€æ‰§è¡Œå¼•æ“                             â”‚
â”‚                   - é˜¶æ®µè°ƒåº¦                                 â”‚
â”‚                   - ç»“æœèšåˆ                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å¤„ç†é˜¶æ®µå±‚ (Stage Layer)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  DeduplicationStage â”‚ AnonymizationStage â”‚ MaskingStage     â”‚
â”‚  - SHA256å“ˆå¸Œå»é‡   â”‚ - å±‚æ¬¡åŒ–IPåŒ¿ååŒ–   â”‚ - åŒæ¨¡å—æ©ç       â”‚
â”‚  - å­—èŠ‚çº§æ¯”è¾ƒ       â”‚ - å­ç½‘ç»“æ„ä¿ç•™     â”‚ - åè®®æ™ºèƒ½åˆ†æ    â”‚
â”‚  - ç©ºé—´èŠ‚çœç»Ÿè®¡     â”‚ - IPv4/IPv6æ”¯æŒ   â”‚ - è§„åˆ™åŒ–å¤„ç†      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Logging           â”‚  Error Handling   â”‚  Resource Mgmt    â”‚
â”‚  - ç»Ÿä¸€æ—¥å¿—ç³»ç»Ÿ     â”‚  - å¼‚å¸¸å¤„ç†        â”‚  - å†…å­˜ç®¡ç†        â”‚
â”‚  - å¤šçº§æ—¥å¿—         â”‚  - é”™è¯¯æ¢å¤        â”‚  - ä¸´æ—¶æ–‡ä»¶æ¸…ç†    â”‚
â”‚  - æ–‡ä»¶/æ§åˆ¶å°è¾“å‡º  â”‚  - ä¸Šä¸‹æ–‡è¿½è¸ª      â”‚  - èµ„æºæ± ç®¡ç†      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è®¾è®¡åŸåˆ™

1. **åˆ†å±‚æ¶æ„** - æ¸…æ™°çš„èŒè´£åˆ†ç¦»ï¼Œæ¯å±‚ä¸“æ³¨ç‰¹å®šåŠŸèƒ½
2. **ç»Ÿä¸€æ¥å£** - GUI å’Œ CLI å…±äº«ç›¸åŒçš„æ ¸å¿ƒå¤„ç†é€»è¾‘
3. **å¯æ‰©å±•æ€§** - æ˜“äºæ·»åŠ æ–°çš„å¤„ç†é˜¶æ®µå’Œåè®®æ”¯æŒ
4. **ç±»å‹å®‰å…¨** - å¼ºç±»å‹æ³¨è§£ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
5. **é”™è¯¯æ¢å¤** - å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œèµ„æºæ¸…ç†æœºåˆ¶

---

## æ•°æ®å¤„ç†æµç¨‹

### å•æ–‡ä»¶å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¾“å…¥    â”‚
â”‚  - è¾“å…¥æ–‡ä»¶  â”‚
â”‚  - è¾“å‡ºè·¯å¾„  â”‚
â”‚  - å¤„ç†é€‰é¡¹  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. é…ç½®æ„å»º (ConfigService)             â”‚
â”‚  - éªŒè¯è¾“å…¥å‚æ•°                          â”‚
â”‚  - æ„å»º ProcessingOptions               â”‚
â”‚  - ç”Ÿæˆ PipelineConfig                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ‰§è¡Œå™¨åˆ›å»º (PipelineExecutor)        â”‚
â”‚  - è§£æé…ç½®                              â”‚
â”‚  - åŠ¨æ€è£…é… Stage åˆ—è¡¨                   â”‚
â”‚  - åˆå§‹åŒ–èµ„æºç®¡ç†å™¨                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. é˜¶æ®µæ‰§è¡Œ (Stage Pipeline)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Stage 1: DeduplicationStage     â”‚   â”‚
â”‚  â”‚ - è¯»å–æ•°æ®åŒ…                     â”‚   â”‚
â”‚  â”‚ - è®¡ç®—å“ˆå¸Œå€¼                     â”‚   â”‚
â”‚  â”‚ - è¿‡æ»¤é‡å¤åŒ…                     â”‚   â”‚
â”‚  â”‚ - å†™å…¥ä¸´æ—¶æ–‡ä»¶                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Stage 2: AnonymizationStage     â”‚   â”‚
â”‚  â”‚ - è¯»å–æ•°æ®åŒ…                     â”‚   â”‚
â”‚  â”‚ - æå–IPåœ°å€                     â”‚   â”‚
â”‚  â”‚ - åº”ç”¨åŒ¿ååŒ–ç­–ç•¥                 â”‚   â”‚
â”‚  â”‚ - é‡å†™IPå­—æ®µ                     â”‚   â”‚
â”‚  â”‚ - å†™å…¥ä¸´æ—¶æ–‡ä»¶                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â†“                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Stage 3: MaskingStage           â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ Marker æ¨¡å— (åè®®åˆ†æ)       â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ - TShark åè®®è§£æ            â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ - ç”Ÿæˆä¿ç•™è§„åˆ™é›†             â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ - TCPåºåˆ—å·æ˜ å°„              â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”‚          â†“                       â”‚   â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â”‚ Masker æ¨¡å— (è½½è·å¤„ç†)       â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ - Scapy æ•°æ®åŒ…è¯»å–           â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ - åº”ç”¨ä¿ç•™è§„åˆ™               â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ - æ©ç æ•æ„Ÿè½½è·               â”‚ â”‚   â”‚
â”‚  â”‚ â”‚ - å†™å…¥æœ€ç»ˆæ–‡ä»¶               â”‚ â”‚   â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. ç»“æœèšåˆä¸æŠ¥å‘Š                       â”‚
â”‚  - æ”¶é›†å„é˜¶æ®µç»Ÿè®¡ä¿¡æ¯                    â”‚
â”‚  - è®¡ç®—æ€»å¤„ç†æ—¶é—´                        â”‚
â”‚  - ç”Ÿæˆå¤„ç†æŠ¥å‘Š                          â”‚
â”‚  - è¿”å› ProcessResult                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å‡ºç»“æœ    â”‚
â”‚  - å¤„ç†æ–‡ä»¶  â”‚
â”‚  - ç»Ÿè®¡æŠ¥å‘Š  â”‚
â”‚  - æ—¥å¿—ä¿¡æ¯  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ‰¹é‡å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¾“å…¥ç›®å½•    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. æ–‡ä»¶æ‰«æ                             â”‚
â”‚  - é€’å½’æŸ¥æ‰¾ .pcap/.pcapng æ–‡ä»¶           â”‚
â”‚  - è¿‡æ»¤éšè—æ–‡ä»¶                          â”‚
â”‚  - æ„å»ºæ–‡ä»¶åˆ—è¡¨                          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. æ‰¹é‡å¤„ç†å¾ªç¯                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  For each file:                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ æ£€æŸ¥ä¸­æ–­æ ‡å¿—                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ å‘é€ FILE_START äº‹ä»¶        â”‚   â”‚
â”‚  â”‚  â”œâ”€ æ‰§è¡Œå•æ–‡ä»¶å¤„ç†æµç¨‹           â”‚   â”‚
â”‚  â”‚  â”œâ”€ æ”¶é›†å¤„ç†ç»“æœ                 â”‚   â”‚
â”‚  â”‚  â”œâ”€ æ›´æ–°è¿›åº¦å›è°ƒ                 â”‚   â”‚
â”‚  â”‚  â””â”€ å‘é€ FILE_END äº‹ä»¶          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ç»“æœæ±‡æ€»                             â”‚
â”‚  - æˆåŠŸæ–‡ä»¶æ•°                            â”‚
â”‚  - å¤±è´¥æ–‡ä»¶æ•°                            â”‚
â”‚  - æ€»å¤„ç†æ—¶é—´                            â”‚
â”‚  - èšåˆç»Ÿè®¡ä¿¡æ¯                          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰¹é‡æŠ¥å‘Š    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®æ¨¡å—è§£æ

### 1. PipelineExecutorï¼ˆç®¡é“æ‰§è¡Œå™¨ï¼‰

**ä½ç½®**: `src/pktmask/core/pipeline/executor.py`

**èŒè´£**:
- æ ¹æ®é…ç½®åŠ¨æ€è£…é…å¤„ç†é˜¶æ®µ
- ç®¡ç†ä¸´æ—¶æ–‡ä»¶å’Œèµ„æº
- åè°ƒé˜¶æ®µé—´çš„æ•°æ®æµè½¬
- æ”¶é›†å’Œèšåˆç»Ÿè®¡ä¿¡æ¯

**æ ¸å¿ƒæ–¹æ³•**:
```python
def run(input_path, output_path, progress_cb) -> ProcessResult:
    """æ‰§è¡Œå®Œæ•´å¤„ç†ç®¡é“"""
    # 1. éªŒè¯è¾“å…¥æ–‡ä»¶
    # 2. åˆ›å»ºä¸´æ—¶ç›®å½•
    # 3. é¡ºåºæ‰§è¡Œå„é˜¶æ®µ
    # 4. æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    # 5. è¿”å›å¤„ç†ç»“æœ
```

**é…ç½®æ ¼å¼**:
```python
config = {
    "remove_dupes": {"enabled": True},
    "anonymize_ips": {"enabled": True},
    "mask_payloads": {
        "enabled": True,
        "protocol": "tls",
        "mode": "enhanced"
    }
}
```

### 2. StageBaseï¼ˆé˜¶æ®µåŸºç±»ï¼‰

**ä½ç½®**: `src/pktmask/core/pipeline/base_stage.py`

**è®¾è®¡æ¨¡å¼**: æ¨¡æ¿æ–¹æ³•æ¨¡å¼

**æ ¸å¿ƒæ¥å£**:
```python
class StageBase(ABC):
    @abstractmethod
    def initialize(config) -> bool:
        """åˆå§‹åŒ–é˜¶æ®µ"""
    
    @abstractmethod
    def process_file(input_path, output_path) -> StageStats:
        """å¤„ç†å•ä¸ªæ–‡ä»¶"""
    
    def prepare_for_directory(directory, all_files):
        """ç›®å½•çº§é¢„å¤„ç†ï¼ˆå¯é€‰ï¼‰"""
    
    def finalize_directory_processing():
        """ç›®å½•çº§åå¤„ç†ï¼ˆå¯é€‰ï¼‰"""
```

**èµ„æºç®¡ç†**:
- ç»Ÿä¸€çš„ä¸´æ—¶æ–‡ä»¶ç®¡ç†
- è‡ªåŠ¨èµ„æºæ¸…ç†
- å¼‚å¸¸æ¢å¤æœºåˆ¶

### 3. MaskingStageï¼ˆæ©ç é˜¶æ®µï¼‰

**ä½ç½®**: `src/pktmask/core/pipeline/stages/masking_stage/`

**åŒæ¨¡å—æ¶æ„**:

#### Marker æ¨¡å—ï¼ˆåè®®åˆ†æå™¨ï¼‰
- **å·¥å…·**: TSharkï¼ˆWiresharkå‘½ä»¤è¡Œå·¥å…·ï¼‰
- **åŠŸèƒ½**: 
  - è§£æåè®®ç»“æ„
  - è¯†åˆ«éœ€è¦ä¿ç•™çš„æ•°æ®åŒ…éƒ¨åˆ†
  - ç”Ÿæˆ TCP åºåˆ—å·ä¿ç•™è§„åˆ™
- **æ”¯æŒåè®®**: TLS, HTTP, Auto-detect

#### Masker æ¨¡å—ï¼ˆè½½è·å¤„ç†å™¨ï¼‰
- **å·¥å…·**: Scapyï¼ˆPythonæ•°æ®åŒ…å¤„ç†åº“ï¼‰
- **åŠŸèƒ½**:
  - è¯»å–æ•°æ®åŒ…
  - åº”ç”¨ä¿ç•™è§„åˆ™
  - æ©ç æ•æ„Ÿè½½è·
  - å†™å…¥å¤„ç†åçš„æ•°æ®åŒ…

**å¤„ç†æµç¨‹**:
```
Input PCAP
    â†“
[Marker] TShark åˆ†æ â†’ KeepRuleSet (TCP seqä¿ç•™è§„åˆ™)
    â†“
[Masker] Scapy åº”ç”¨è§„åˆ™ â†’ æ©ç è½½è·
    â†“
Output PCAP
```

### 4. ConfigServiceï¼ˆé…ç½®æœåŠ¡ï¼‰

**ä½ç½®**: `src/pktmask/services/config_service.py`

**èŒè´£**:
- ç»Ÿä¸€é…ç½®æ„å»º
- GUI/CLI å‚æ•°é€‚é…
- é…ç½®éªŒè¯

**æ•°æ®æ¨¡å‹**:
```python
@dataclass
class ProcessingOptions:
    enable_remove_dupes: bool = False
    enable_anonymize_ips: bool = False
    enable_mask_payloads: bool = False
    mask_protocol: str = "tls"
    preserve_handshake: bool = True
    preserve_alert: bool = True
    # ... æ›´å¤šé…ç½®é¡¹
```

**é…ç½®è½¬æ¢**:
```
GUI Checkboxes â†’ ProcessingOptions â†’ PipelineConfig
CLI Arguments  â†’ ProcessingOptions â†’ PipelineConfig
```

### 5. GUI ç®¡ç†å™¨æ¶æ„

**ä½ç½®**: `src/pktmask/gui/managers/`

**ç®¡ç†å™¨èŒè´£åˆ†ç¦»**:

| ç®¡ç†å™¨ | èŒè´£ |
|--------|------|
| **UIManager** | UIç»„ä»¶åˆ›å»ºã€å¸ƒå±€ç®¡ç†ã€æ ·å¼åº”ç”¨ |
| **FileManager** | æ–‡ä»¶é€‰æ‹©ã€ç›®å½•æ‰«æã€è·¯å¾„éªŒè¯ |
| **PipelineManager** | æ‰§è¡Œå™¨åˆ›å»ºã€çº¿ç¨‹ç®¡ç†ã€è¿›åº¦è·Ÿè¸ª |
| **ReportManager** | æŠ¥å‘Šç”Ÿæˆã€ç»Ÿè®¡å±•ç¤ºã€ç»“æœå¯¼å‡º |
| **DialogManager** | å¯¹è¯æ¡†ç®¡ç†ã€ç”¨æˆ·äº¤äº’ã€æ¶ˆæ¯æç¤º |
| **EventCoordinator** | äº‹ä»¶åˆ†å‘ã€ç®¡ç†å™¨é—´é€šä¿¡ |

**äº‹ä»¶é©±åŠ¨æ¨¡å‹**:
```python
class PipelineEvents(Enum):
    PIPELINE_START = "pipeline_start"
    FILE_START = "file_start"
    STAGE_START = "stage_start"
    STAGE_END = "stage_end"
    FILE_END = "file_end"
    PIPELINE_END = "pipeline_end"
    ERROR = "error"
    LOG = "log"
```

---

## æŠ€æœ¯æ ˆ

### æ ¸å¿ƒä¾èµ–

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| **Python** | 3.8+ | ä¸»è¦ç¼–ç¨‹è¯­è¨€ |
| **Scapy** | Latest | æ•°æ®åŒ…è¯»å†™å’Œå¤„ç† |
| **PyQt6** | Latest | GUI æ¡†æ¶ |
| **Typer** | Latest | CLI æ¡†æ¶ |
| **TShark** | Latest | åè®®åˆ†æï¼ˆå¤–éƒ¨å·¥å…·ï¼‰ |

### å¼€å‘å·¥å…·

| å·¥å…· | ç”¨é€” |
|------|------|
| **pytest** | å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯• |
| **flake8** | ä»£ç é£æ ¼æ£€æŸ¥ |
| **black** | ä»£ç æ ¼å¼åŒ– |
| **mypy** | ç±»å‹æ£€æŸ¥ |
| **PyInstaller** | å¯æ‰§è¡Œæ–‡ä»¶æ‰“åŒ… |

### é¡¹ç›®ç»“æ„

```
PktMask/
â”œâ”€â”€ src/pktmask/              # æºä»£ç 
â”‚   â”œâ”€â”€ __main__.py           # å…¥å£ç‚¹
â”‚   â”œâ”€â”€ cli/                  # CLI æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ commands.py       # CLI å‘½ä»¤
â”‚   â”‚   â””â”€â”€ formatters.py     # è¾“å‡ºæ ¼å¼åŒ–
â”‚   â”œâ”€â”€ gui/                  # GUI æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ main_window.py    # ä¸»çª—å£
â”‚   â”‚   â””â”€â”€ managers/         # ç®¡ç†å™¨
â”‚   â”œâ”€â”€ core/                 # æ ¸å¿ƒå¤„ç†
â”‚   â”‚   â”œâ”€â”€ pipeline/         # ç®¡é“ç³»ç»Ÿ
â”‚   â”‚   â”‚   â”œâ”€â”€ executor.py   # æ‰§è¡Œå™¨
â”‚   â”‚   â”‚   â”œâ”€â”€ base_stage.py # é˜¶æ®µåŸºç±»
â”‚   â”‚   â”‚   â””â”€â”€ stages/       # å¤„ç†é˜¶æ®µ
â”‚   â”‚   â”œâ”€â”€ strategy.py       # åŒ¿ååŒ–ç­–ç•¥
â”‚   â”‚   â””â”€â”€ consistency.py    # ä¸€è‡´æ€§å¤„ç†å™¨
â”‚   â”œâ”€â”€ services/             # æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ config_service.py # é…ç½®æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ pipeline_service.py # ç®¡é“æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ progress_service.py # è¿›åº¦æœåŠ¡
â”‚   â”‚   â””â”€â”€ report_service.py # æŠ¥å‘ŠæœåŠ¡
â”‚   â”œâ”€â”€ domain/               # é¢†åŸŸæ¨¡å‹
â”‚   â”‚   â””â”€â”€ models/           # æ•°æ®æ¨¡å‹
â”‚   â”œâ”€â”€ infrastructure/       # åŸºç¡€è®¾æ–½
â”‚   â”‚   â”œâ”€â”€ logging/          # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ error_handling/   # é”™è¯¯å¤„ç†
â”‚   â”‚   â””â”€â”€ dependency/       # ä¾èµ–ç®¡ç†
â”‚   â”œâ”€â”€ common/               # å…¬å…±æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ constants.py      # å¸¸é‡å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ enums.py          # æšä¸¾ç±»å‹
â”‚   â”‚   â””â”€â”€ exceptions.py     # å¼‚å¸¸ç±»
â”‚   â”œâ”€â”€ config/               # é…ç½®æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ settings.py       # åº”ç”¨é…ç½®
â”‚   â”‚   â””â”€â”€ defaults.py       # é»˜è®¤å€¼
â”‚   â””â”€â”€ utils/                # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ file_ops.py       # æ–‡ä»¶æ“ä½œ
â”‚       â”œâ”€â”€ reporting.py      # æŠ¥å‘Šå·¥å…·
â”‚       â””â”€â”€ subprocess_utils.py # å­è¿›ç¨‹å·¥å…·
â”œâ”€â”€ tests/                    # æµ‹è¯•ä»£ç 
â”‚   â”œâ”€â”€ unit/                 # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ integration/          # é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ e2e/                  # ç«¯åˆ°ç«¯æµ‹è¯•
â”œâ”€â”€ docs/                     # æ–‡æ¡£
â”‚   â”œâ”€â”€ user/                 # ç”¨æˆ·æ–‡æ¡£
â”‚   â”œâ”€â”€ dev/                  # å¼€å‘æ–‡æ¡£
â”‚   â””â”€â”€ api/                  # API æ–‡æ¡£
â”œâ”€â”€ config/                   # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ app/                  # åº”ç”¨é…ç½®
â”‚   â””â”€â”€ templates/            # é…ç½®æ¨¡æ¿
â”œâ”€â”€ scripts/                  # è„šæœ¬å·¥å…·
â”‚   â”œâ”€â”€ build/                # æ„å»ºè„šæœ¬
â”‚   â”œâ”€â”€ test/                 # æµ‹è¯•è„šæœ¬
â”‚   â””â”€â”€ validation/           # éªŒè¯è„šæœ¬
â””â”€â”€ output/                   # è¾“å‡ºç›®å½•
```

---

## æ•°æ®æµè¯¦è§£

### é…ç½®æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç”¨æˆ·è¾“å…¥     â”‚
â”‚  GUI/CLI     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ProcessingOptions           â”‚
â”‚  - enable_remove_dupes       â”‚
â”‚  - enable_anonymize_ips      â”‚
â”‚  - enable_mask_payloads      â”‚
â”‚  - mask_protocol             â”‚
â”‚  - preserve_* options        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PipelineConfig (Dict)       â”‚
â”‚  {                           â”‚
â”‚    "remove_dupes": {...},    â”‚
â”‚    "anonymize_ips": {...},   â”‚
â”‚    "mask_payloads": {        â”‚
â”‚      "protocol": "tls",      â”‚
â”‚      "marker_config": {...}, â”‚
â”‚      "masker_config": {...}  â”‚
â”‚    }                         â”‚
â”‚  }                           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PipelineExecutor            â”‚
â”‚  - è§£æé…ç½®                   â”‚
â”‚  - åˆ›å»º Stage å®ä¾‹            â”‚
â”‚  - åˆå§‹åŒ–èµ„æº                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®åŒ…å¤„ç†æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Input PCAP  â”‚
â”‚  (åŸå§‹æ–‡ä»¶)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 1: Deduplication             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ For each packet:              â”‚  â”‚
â”‚  â”‚ 1. è¯»å–æ•°æ®åŒ…                  â”‚  â”‚
â”‚  â”‚ 2. è®¡ç®— SHA256 å“ˆå¸Œ            â”‚  â”‚
â”‚  â”‚ 3. æ£€æŸ¥å“ˆå¸Œé›†åˆ                â”‚  â”‚
â”‚  â”‚ 4. å¦‚æœæ–°åŒ…ï¼Œæ·»åŠ åˆ°è¾“å‡º        â”‚  â”‚
â”‚  â”‚ 5. å¦‚æœé‡å¤ï¼Œè·³è¿‡              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Temp File 1 â”‚
â”‚  (å»é‡å)     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 2: Anonymization             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ For each packet:              â”‚  â”‚
â”‚  â”‚ 1. è¯»å–æ•°æ®åŒ…                  â”‚  â”‚
â”‚  â”‚ 2. æå– IP å±‚                  â”‚  â”‚
â”‚  â”‚ 3. æå–æº/ç›®æ ‡ IP              â”‚  â”‚
â”‚  â”‚ 4. åº”ç”¨åŒ¿ååŒ–ç­–ç•¥              â”‚  â”‚
â”‚  â”‚ 5. é‡å†™ IP å­—æ®µ                â”‚  â”‚
â”‚  â”‚ 6. é‡æ–°è®¡ç®—æ ¡éªŒå’Œ              â”‚  â”‚
â”‚  â”‚ 7. å†™å…¥è¾“å‡º                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Temp File 2 â”‚
â”‚  (IPåŒ¿ååŒ–)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage 3: Masking                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Phase 1: Marker (TShark)      â”‚  â”‚
â”‚  â”‚ 1. è¿è¡Œ TShark åˆ†æ            â”‚  â”‚
â”‚  â”‚ 2. è§£æåè®®å­—æ®µ                â”‚  â”‚
â”‚  â”‚ 3. è¯†åˆ«ä¿ç•™éƒ¨åˆ†                â”‚  â”‚
â”‚  â”‚ 4. ç”Ÿæˆ KeepRuleSet            â”‚  â”‚
â”‚  â”‚    - TCP seq â†’ keep/mask      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Phase 2: Masker (Scapy)       â”‚  â”‚
â”‚  â”‚ For each packet:              â”‚  â”‚
â”‚  â”‚ 1. è¯»å–æ•°æ®åŒ…                  â”‚  â”‚
â”‚  â”‚ 2. æå– TCP å±‚                 â”‚  â”‚
â”‚  â”‚ 3. è·å– TCP seq                â”‚  â”‚
â”‚  â”‚ 4. æŸ¥è¯¢ KeepRuleSet            â”‚  â”‚
â”‚  â”‚ 5. å¦‚æœéœ€è¦æ©ç ï¼š              â”‚  â”‚
â”‚  â”‚    - æ¸…é›¶è½½è·æ•°æ®              â”‚  â”‚
â”‚  â”‚    - ä¿ç•™åè®®å¤´                â”‚  â”‚
â”‚  â”‚ 6. å¦‚æœéœ€è¦ä¿ç•™ï¼š              â”‚  â”‚
â”‚  â”‚    - ä¿æŒåŸå§‹è½½è·              â”‚  â”‚
â”‚  â”‚ 7. å†™å…¥è¾“å‡º                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Output PCAP  â”‚
â”‚ (æœ€ç»ˆæ–‡ä»¶)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»Ÿè®¡ä¿¡æ¯æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage Stats â”‚ (æ¯ä¸ªé˜¶æ®µ)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  StageStats                     â”‚
â”‚  - stage_name: str              â”‚
â”‚  - packets_processed: int       â”‚
â”‚  - packets_modified: int        â”‚
â”‚  - duration_ms: float           â”‚
â”‚  - extra_metrics: Dict          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ProcessResult                  â”‚
â”‚  - success: bool                â”‚
â”‚  - input_file: str              â”‚
â”‚  - output_file: str             â”‚
â”‚  - duration_ms: float           â”‚
â”‚  - stage_stats: List[StageStats]â”‚
â”‚  - errors: List[str]            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Report Generation              â”‚
â”‚  - æ–‡æœ¬æ ¼å¼æŠ¥å‘Š                  â”‚
â”‚  - JSON æ ¼å¼æŠ¥å‘Š                 â”‚
â”‚  - ç»Ÿè®¡å›¾è¡¨ï¼ˆGUIï¼‰               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…³é”®è®¾è®¡æ¨¡å¼

### 1. ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰

**åº”ç”¨**: IP åŒ¿ååŒ–ç­–ç•¥

```python
class HierarchicalAnonymizationStrategy:
    """å±‚æ¬¡åŒ–åŒ¿ååŒ–ç­–ç•¥"""
    def anonymize_ip(self, ip_address):
        # ä¿ç•™å­ç½‘ç»“æ„çš„åŒ¿ååŒ–
        pass
```

### 2. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼ˆTemplate Method Patternï¼‰

**åº”ç”¨**: StageBase åŸºç±»

```python
class StageBase(ABC):
    def process_file(self, input_path, output_path):
        # æ¨¡æ¿æ–¹æ³•å®šä¹‰å¤„ç†æµç¨‹
        self.initialize()
        result = self._do_process()
        self.cleanup()
        return result

    @abstractmethod
    def _do_process(self):
        # å­ç±»å®ç°å…·ä½“å¤„ç†é€»è¾‘
        pass
```

### 3. è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰

**åº”ç”¨**: è¿›åº¦å›è°ƒç³»ç»Ÿ

```python
# å‘å¸ƒè€…
executor.run(input_path, output_path, progress_callback)

# è®¢é˜…è€…
def on_progress(event, data):
    if event == PipelineEvents.STAGE_END:
        update_progress_bar(data)
```

### 4. å·¥å‚æ¨¡å¼ï¼ˆFactory Patternï¼‰

**åº”ç”¨**: Stage åˆ›å»º

```python
def _build_pipeline(self, config):
    stages = []
    if config.get("remove_dupes", {}).get("enabled"):
        stages.append(DeduplicationStage(config["remove_dupes"]))
    if config.get("anonymize_ips", {}).get("enabled"):
        stages.append(AnonymizationStage(config["anonymize_ips"]))
    # ...
    return stages
```

### 5. é€‚é…å™¨æ¨¡å¼ï¼ˆAdapter Patternï¼‰

**åº”ç”¨**: GUI/CLI é…ç½®é€‚é…

```python
class ConfigService:
    def create_options_from_gui(self, checkboxes):
        # GUI â†’ ProcessingOptions
        pass

    def create_options_from_cli(self, args):
        # CLI â†’ ProcessingOptions
        pass
```

---

## é”™è¯¯å¤„ç†æœºåˆ¶

### å¼‚å¸¸å±‚æ¬¡ç»“æ„

```
Exception
â””â”€â”€ PktMaskException (åŸºç¡€å¼‚å¸¸)
    â”œâ”€â”€ ConfigurationError (é…ç½®é”™è¯¯)
    â”œâ”€â”€ FileError (æ–‡ä»¶é”™è¯¯)
    â”‚   â”œâ”€â”€ FileNotFoundError
    â”‚   â””â”€â”€ FilePermissionError
    â”œâ”€â”€ ProcessingError (å¤„ç†é”™è¯¯)
    â”‚   â”œâ”€â”€ StageError
    â”‚   â””â”€â”€ ValidationError
    â””â”€â”€ ResourceError (èµ„æºé”™è¯¯)
        â”œâ”€â”€ MemoryError
        â””â”€â”€ DiskSpaceError
```

### é”™è¯¯æ¢å¤ç­–ç•¥

```python
class StageBase:
    def process_file(self, input_path, output_path):
        retry_count = 0
        while retry_count < self.max_retry_attempts:
            try:
                return self._do_process(input_path, output_path)
            except RecoverableError as e:
                retry_count += 1
                self.logger.warning(f"Retry {retry_count}/{self.max_retry_attempts}")
                time.sleep(self.retry_delay_seconds)
            except FatalError as e:
                self.logger.error(f"Fatal error: {e}")
                raise
```

### èµ„æºæ¸…ç†

```python
def run(self, input_path, output_path):
    with tempfile.TemporaryDirectory() as temp_dir:
        try:
            # å¤„ç†é€»è¾‘
            result = self._process_pipeline(input_path, output_path, temp_dir)
        except Exception as e:
            # é”™è¯¯å¤„ç†
            log_exception(e)
            raise
        finally:
            # è‡ªåŠ¨æ¸…ç†ä¸´æ—¶ç›®å½•
            pass
    return result
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. å†…å­˜ç®¡ç†

- **æµå¼å¤„ç†**: é€åŒ…è¯»å–ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½æ•´ä¸ªæ–‡ä»¶
- **ä¸´æ—¶æ–‡ä»¶**: ä½¿ç”¨ç£ç›˜ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ä¸­é—´ç»“æœ
- **èµ„æºæ± **: å¤ç”¨å¯¹è±¡ï¼Œå‡å°‘å†…å­˜åˆ†é…

### 2. å¹¶å‘å¤„ç†

- **é˜¶æ®µå†…å¹¶å‘**: æŸäº›é˜¶æ®µæ”¯æŒå¤šçº¿ç¨‹å¤„ç†
- **æ–‡ä»¶çº§å¹¶å‘**: æ‰¹é‡å¤„ç†æ—¶å¯å¹¶è¡Œå¤„ç†å¤šä¸ªæ–‡ä»¶ï¼ˆå®éªŒæ€§ï¼‰

### 3. ç¼“å­˜ç­–ç•¥

- **å“ˆå¸Œç¼“å­˜**: å»é‡é˜¶æ®µç¼“å­˜å·²è§è¿‡çš„å“ˆå¸Œå€¼
- **IPæ˜ å°„ç¼“å­˜**: åŒ¿ååŒ–é˜¶æ®µç¼“å­˜IPæ˜ å°„å…³ç³»

---

## æµ‹è¯•ç­–ç•¥

### æµ‹è¯•é‡‘å­—å¡”

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  E2E    â”‚  ç«¯åˆ°ç«¯æµ‹è¯•
        â”‚  Tests  â”‚  - GUI å·¥ä½œæµ
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  - CLI å‘½ä»¤
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚Integrationâ”‚ é›†æˆæµ‹è¯•
       â”‚   Tests   â”‚ - ç®¡é“æ‰§è¡Œ
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ - æœåŠ¡äº¤äº’
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚    Unit     â”‚ å•å…ƒæµ‹è¯•
      â”‚    Tests    â”‚ - å•ä¸ªå‡½æ•°
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ - ç±»æ–¹æ³•
```

### æµ‹è¯•è¦†ç›–

| æ¨¡å— | æµ‹è¯•ç±»å‹ | è¦†ç›–ç‡ç›®æ ‡ |
|------|---------|-----------|
| Core Pipeline | Unit + Integration | 90%+ |
| Stages | Unit + Integration | 85%+ |
| Services | Unit | 80%+ |
| GUI | Integration + E2E | 70%+ |
| CLI | Integration + E2E | 85%+ |

---

## éƒ¨ç½²ä¸æ‰“åŒ…

### æ‰“åŒ…æµç¨‹

```
Source Code
    â†“
[PyInstaller]
    â†“
â”œâ”€ Windows (.exe)
â”œâ”€ macOS (.app)
â””â”€ Linux (binary)
```

### é…ç½®æ–‡ä»¶

```
PktMask.spec (PyInstalleré…ç½®)
â”œâ”€ å…¥å£ç‚¹: pktmask_launcher.py
â”œâ”€ éšè—å¯¼å…¥: PyQt6, scapy
â”œâ”€ æ•°æ®æ–‡ä»¶: config/, assets/
â””â”€ å›¾æ ‡: assets/PktMask.ico
```

---

## æ€»ç»“

PktMask æ˜¯ä¸€ä¸ªè®¾è®¡è‰¯å¥½ã€æ¶æ„æ¸…æ™°çš„ç½‘ç»œæ•°æ®åŒ…å¤„ç†å·¥å…·ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

### âœ… ä¼˜åŠ¿

1. **ç»Ÿä¸€æ¶æ„** - GUI å’Œ CLI å…±äº«æ ¸å¿ƒé€»è¾‘ï¼Œç¡®ä¿ä¸€è‡´æ€§
2. **æ¨¡å—åŒ–è®¾è®¡** - æ¸…æ™°çš„èŒè´£åˆ†ç¦»ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
3. **ç±»å‹å®‰å…¨** - å®Œæ•´çš„ç±»å‹æ³¨è§£ï¼Œå‡å°‘è¿è¡Œæ—¶é”™è¯¯
4. **é”™è¯¯æ¢å¤** - å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œèµ„æºç®¡ç†
5. **å¯æ‰©å±•æ€§** - æ˜“äºæ·»åŠ æ–°çš„å¤„ç†é˜¶æ®µå’Œåè®®æ”¯æŒ
6. **åŒæ¨¡å—æ©ç ** - Marker + Masker æ¶æ„ï¼Œåè®®åˆ†æä¸å¤„ç†åˆ†ç¦»

### ğŸ¯ æ ¸å¿ƒä»·å€¼

- **å®‰å…¨æ€§**: æœ‰æ•ˆç§»é™¤æ•æ„Ÿä¿¡æ¯ï¼Œä¿æŠ¤éšç§
- **å¯ç”¨æ€§**: ä¿ç•™åˆ†æä»·å€¼ï¼Œæ”¯æŒæ•…éšœæ’æŸ¥
- **æ˜“ç”¨æ€§**: å›¾å½¢ç•Œé¢å‹å¥½ï¼Œå‘½ä»¤è¡Œçµæ´»
- **å¯é æ€§**: å®Œå–„çš„æµ‹è¯•å’Œé”™è¯¯å¤„ç†

### ğŸš€ æœªæ¥æ–¹å‘

1. æ”¯æŒæ›´å¤šåè®®ï¼ˆDNS, SMTP, etc.ï¼‰
2. æ’ä»¶åŒ–æ¶æ„
3. Web ç•Œé¢æ”¯æŒ
4. æ€§èƒ½ä¼˜åŒ–ï¼ˆå¤§æ–‡ä»¶å¤„ç†ï¼‰
5. äº‘ç«¯å¤„ç†æ”¯æŒ


