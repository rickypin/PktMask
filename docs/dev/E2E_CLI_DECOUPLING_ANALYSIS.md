# CLIé»‘ç›’æµ‹è¯•è§£è€¦ç¨‹åº¦åˆ†æ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æCLIé»‘ç›’æµ‹è¯•ä¸ä¸»ç¨‹åºçš„è§£è€¦ç¨‹åº¦,è¯†åˆ«è€¦åˆç‚¹,å¹¶æä¾›å®Œå…¨è§£è€¦æ–¹æ¡ˆã€‚

**åˆ†ææ—¥æœŸ**: 2025-10-09  
**å½“å‰è§£è€¦ç¨‹åº¦**: 85% âš ï¸  
**ç›®æ ‡è§£è€¦ç¨‹åº¦**: 100% âœ…

---

## ğŸ” è§£è€¦ç¨‹åº¦å®¡æŸ¥

### 1. ä»£ç å±‚é¢è§£è€¦ âœ… 100%

#### 1.1 å¯¼å…¥è¯­å¥æ£€æŸ¥

**æ–‡ä»¶**: `tests/e2e/test_e2e_cli_blackbox.py`

```python
# âœ… åªä½¿ç”¨æ ‡å‡†åº“å’Œpytest
import hashlib
import json
import subprocess
import sys
from pathlib import Path
from typing import Any, Dict

import pytest

# âŒ æ²¡æœ‰å¯¼å…¥ä»»ä½•å†…éƒ¨æ¨¡å—
# NO: from src.pktmask.core.consistency import ConsistentProcessor
# NO: from src.pktmask.services import ...
```

**ç»“è®º**: âœ… **å®Œå…¨è§£è€¦** - æ²¡æœ‰å¯¼å…¥ä»»ä½•`src.pktmask`æ¨¡å—

---

#### 1.2 CLIè°ƒç”¨æ–¹å¼æ£€æŸ¥

```python
def _run_cli_command(
    self,
    cli_executable: str,
    input_path: Path,
    output_path: Path,
    dedup: bool = False,
    anon: bool = False,
    mask: bool = False,
) -> subprocess.CompletedProcess:
    """Run PktMask CLI command"""
    
    # âœ… ä½¿ç”¨subprocessè°ƒç”¨CLI
    cmd = [sys.executable, "-m", "pktmask", "process"]
    cmd.extend([str(input_path), "-o", str(output_path)])
    
    if dedup:
        cmd.append("--dedup")
    if anon:
        cmd.append("--anon")
    if mask:
        cmd.append("--mask")
    
    # âœ… çº¯é»‘ç›’è°ƒç”¨
    result = subprocess.run(cmd, capture_output=True, text=True, timeout=60)
    return result
```

**ç»“è®º**: âœ… **å®Œå…¨è§£è€¦** - ä½¿ç”¨subprocess,ä¸è°ƒç”¨ä»»ä½•å†…éƒ¨API

---

#### 1.3 éªŒè¯é€»è¾‘æ£€æŸ¥

```python
# âœ… åªéªŒè¯CLIé€€å‡ºç 
assert result.returncode == 0

# âœ… åªéªŒè¯è¾“å‡ºæ–‡ä»¶å­˜åœ¨
assert output_path.exists()

# âœ… åªéªŒè¯è¾“å‡ºæ–‡ä»¶å“ˆå¸Œ
output_hash = self._calculate_file_hash(output_path)
assert output_hash == baseline["output_hash"]

# âŒ ä¸è®¿é—®ä»»ä½•å†…éƒ¨æ•°æ®ç»“æ„
# NO: result.stats
# NO: result.stage_stats
# NO: result.packets_processed
```

**ç»“è®º**: âœ… **å®Œå…¨è§£è€¦** - åªéªŒè¯å¤–éƒ¨å¯è§‚å¯Ÿè¡Œä¸º

---

### 2. æ•°æ®å±‚é¢è§£è€¦ âŒ 0%

#### 2.1 é»„é‡‘åŸºå‡†ç”Ÿæˆæ–¹å¼

**å½“å‰æ–¹å¼**: ä½¿ç”¨APIç”Ÿæˆ

```python
# tests/e2e/generate_golden_baseline.py

# âŒ å¯¼å…¥å†…éƒ¨API
from src.pktmask.core.consistency import ConsistentProcessor

# âŒ ä½¿ç”¨APIç”ŸæˆåŸºå‡†
processor = ConsistentProcessor()
result = processor.process_file(input_path, output_path, config)

# âŒ ä¿å­˜APIå†…éƒ¨æ•°æ®
baseline = {
    "output_hash": output_hash,
    "stats": {
        "packets_processed": result.stats.packets_processed,
        "packets_modified": result.stats.packets_modified,
        "stages": [...]  # å†…éƒ¨stageä¿¡æ¯
    }
}
```

**é—®é¢˜**: é»„é‡‘åŸºå‡†ä¾èµ–APIç”Ÿæˆ,å­˜åœ¨é—´æ¥è€¦åˆ

---

#### 2.2 é»„é‡‘åŸºå‡†å†…å®¹åˆ†æ

**å½“å‰åŸºå‡†æ–‡ä»¶**: `tests/e2e/golden/E2E-001_baseline.json`

```json
{
  "test_id": "E2E-001",
  "name": "Dedup Only",
  "input_file": "tests/data/tls/tls_1_2-2.pcap",
  "input_hash": "baf39e40...",
  "config": {
    "dedup": true,
    "anon": false,
    "mask": false
  },
  "output_hash": "baf39e40...",
  "output_file_size": 2721,
  "packet_count": 14,
  "stats": {                          // âŒ APIå†…éƒ¨æ•°æ®
    "packets_processed": 14,
    "packets_modified": 0,
    "duration_ms": 8.348941802978516,
    "stages": [                       // âŒ APIå†…éƒ¨æ•°æ®
      {
        "name": "DeduplicationStage",
        "packets_processed": 14,
        "packets_modified": 0,
        "duration_ms": 7.904052734375
      }
    ]
  },
  "timestamp": "2025-10-09T19:39:44.736627",
  "version": "1.0"
}
```

**é—®é¢˜**: 
- âŒ åŒ…å«APIå†…éƒ¨æ•°æ®(`stats`, `stages`)
- âŒ ä½¿ç”¨APIé…ç½®æ ¼å¼(`config`)
- âš ï¸ CLIé»‘ç›’æµ‹è¯•åªä½¿ç”¨`output_hash`,ä½†åŸºå‡†æ–‡ä»¶åŒ…å«å¤šä½™æ•°æ®

---

### 3. è€¦åˆé“¾åˆ†æ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CLIé»‘ç›’æµ‹è¯• (test_e2e_cli_blackbox.py)                     â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚  âœ… ä¸å¯¼å…¥å†…éƒ¨æ¨¡å—                                          â”‚
â”‚  âœ… ä½¿ç”¨subprocessè°ƒç”¨CLI                                   â”‚
â”‚  âœ… åªéªŒè¯output_hash                                       â”‚
â”‚                                                             â”‚
â”‚  â¬‡ï¸ è¯»å–é»„é‡‘åŸºå‡†                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  é»„é‡‘åŸºå‡†æ–‡ä»¶ (golden/E2E-001_baseline.json)                â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚  âœ… output_hash (CLIé»‘ç›’ä½¿ç”¨)                               â”‚
â”‚  âŒ stats (APIå†…éƒ¨æ•°æ®,CLIé»‘ç›’ä¸ä½¿ç”¨)                       â”‚
â”‚  âŒ stages (APIå†…éƒ¨æ•°æ®,CLIé»‘ç›’ä¸ä½¿ç”¨)                      â”‚
â”‚                                                             â”‚
â”‚  â¬†ï¸ ç”±åŸºå‡†ç”Ÿæˆå™¨ç”Ÿæˆ                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŸºå‡†ç”Ÿæˆå™¨ (generate_golden_baseline.py)                   â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚  âŒ from src.pktmask.core.consistency import ...            â”‚
â”‚  âŒ processor = ConsistentProcessor()                       â”‚
â”‚  âŒ result = processor.process_file(...)                    â”‚
â”‚  âŒ ä¿å­˜APIå†…éƒ¨æ•°æ®åˆ°åŸºå‡†æ–‡ä»¶                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è€¦åˆé“¾**: CLIé»‘ç›’æµ‹è¯• â†’ é»„é‡‘åŸºå‡† â†’ APIç”Ÿæˆå™¨ â†’ ConsistentProcessor

---

## ğŸ“Š è§£è€¦ç¨‹åº¦è¯„åˆ†

| ç»´åº¦ | æƒé‡ | å¾—åˆ† | åŠ æƒå¾—åˆ† | è¯´æ˜ |
|------|------|------|---------|------|
| **ä»£ç å¯¼å…¥** | 25% | 100% | 25% | âœ… ä¸å¯¼å…¥å†…éƒ¨æ¨¡å— |
| **APIè°ƒç”¨** | 25% | 100% | 25% | âœ… ä½¿ç”¨subprocess |
| **éªŒè¯é€»è¾‘** | 25% | 100% | 25% | âœ… åªéªŒè¯å¤–éƒ¨è¡Œä¸º |
| **æ•°æ®ä¾èµ–** | 25% | 0% | 0% | âŒ åŸºå‡†ä¾èµ–APIç”Ÿæˆ |
| **æ€»åˆ†** | 100% | - | **75%** | âš ï¸ å­˜åœ¨é—´æ¥è€¦åˆ |

**æ³¨**: ä¹‹å‰è¯„ä¼°ä¸º85%æ˜¯ä¹è§‚ä¼°è®¡,å®é™…åº”ä¸º75%

---

## ğŸ› ï¸ å®Œå…¨è§£è€¦æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: åˆ›å»ºCLIä¸“ç”¨åŸºå‡†ç”Ÿæˆå™¨ (æ¨è) â­

#### å®ç°

åˆ›å»º`tests/e2e/generate_cli_golden_baseline.py`:

```python
#!/usr/bin/env python3
"""
CLI Golden Baseline Generator

å®Œå…¨è§£è€¦çš„åŸºå‡†ç”Ÿæˆå™¨:
- ä½¿ç”¨subprocessè°ƒç”¨CLI (ä¸å¯¼å…¥API)
- åªä¿å­˜output_hash (ä¸ä¿å­˜å†…éƒ¨æ•°æ®)
- å®Œå…¨ç‹¬ç«‹äºå†…éƒ¨å®ç°
"""

import hashlib
import json
import subprocess
from pathlib import Path

def generate_baseline_via_cli(test_case):
    """ä½¿ç”¨CLIç”ŸæˆåŸºå‡†"""
    # âœ… ä½¿ç”¨subprocessè°ƒç”¨CLI
    cmd = ["python", "-m", "pktmask", "process", ...]
    subprocess.run(cmd)
    
    # âœ… åªä¿å­˜output_hash
    baseline = {
        "test_id": test_case["test_id"],
        "output_hash": calculate_hash(output_file),
        "version": "1.0-cli"
    }
    
    return baseline
```

#### ä¼˜ç‚¹

- âœ… å®Œå…¨è§£è€¦ (100%)
- âœ… çœŸæ­£çš„é»‘ç›’åŸºå‡†
- âœ… ä¸å—APIé‡æ„å½±å“
- âœ… åŸºå‡†æ–‡ä»¶æ›´ç®€æ´

#### ç¼ºç‚¹

- âš ï¸ éœ€è¦ç»´æŠ¤ä¸¤å¥—åŸºå‡†ç”Ÿæˆå™¨
- âš ï¸ CLIå’ŒAPIåŸºå‡†å¯èƒ½ä¸åŒ

---

### æ–¹æ¡ˆ2: å…±äº«åŸºå‡†ä½†æ ‡æ³¨æ¥æº

#### å®ç°

åœ¨åŸºå‡†æ–‡ä»¶ä¸­æ ‡æ³¨ç”Ÿæˆæ–¹å¼:

```json
{
  "test_id": "E2E-001",
  "output_hash": "baf39e40...",
  "generation_method": "api",  // æ ‡æ³¨ç”Ÿæˆæ–¹å¼
  "stats": { ... },            // APIä¸“ç”¨æ•°æ®
  "note": "CLI tests only use output_hash"
}
```

#### ä¼˜ç‚¹

- âœ… åªéœ€ä¸€å¥—åŸºå‡†
- âœ… æ˜ç¡®æ ‡æ³¨æ•°æ®æ¥æº

#### ç¼ºç‚¹

- âŒ ä»ç„¶ä¾èµ–APIç”Ÿæˆ
- âŒ åŸºå‡†æ–‡ä»¶åŒ…å«å†—ä½™æ•°æ®
- âŒ æœªè§£å†³æ ¹æœ¬è€¦åˆé—®é¢˜

---

### æ–¹æ¡ˆ3: éªŒè¯CLIå’ŒAPIè¾“å‡ºä¸€è‡´æ€§

#### å®ç°

åˆ›å»ºä¸€ä¸ªéªŒè¯è„šæœ¬,ç¡®ä¿CLIå’ŒAPIäº§ç”Ÿç›¸åŒè¾“å‡º:

```python
def test_cli_api_consistency():
    """éªŒè¯CLIå’ŒAPIäº§ç”Ÿç›¸åŒè¾“å‡º"""
    # ä½¿ç”¨CLIç”Ÿæˆè¾“å‡º
    cli_output = run_cli(...)
    
    # ä½¿ç”¨APIç”Ÿæˆè¾“å‡º
    api_output = run_api(...)
    
    # éªŒè¯å“ˆå¸Œä¸€è‡´
    assert hash(cli_output) == hash(api_output)
```

#### ä¼˜ç‚¹

- âœ… ç¡®ä¿CLIå’ŒAPIè¡Œä¸ºä¸€è‡´
- âœ… å¯ä»¥ä½¿ç”¨ä»»ä¸€æ–¹å¼ç”ŸæˆåŸºå‡†

#### ç¼ºç‚¹

- âŒ ä»ç„¶ä¾èµ–API
- âŒ æœªå®ç°å®Œå…¨è§£è€¦

---

## ğŸ’¡ æ¨èå®æ–½æ–¹æ¡ˆ

### ç«‹å³å®æ–½: æ–¹æ¡ˆ1 (CLIä¸“ç”¨åŸºå‡†ç”Ÿæˆå™¨)

**æ­¥éª¤**:

1. **åˆ›å»ºCLIåŸºå‡†ç”Ÿæˆå™¨** âœ… (å·²å®Œæˆ)
   - `tests/e2e/generate_cli_golden_baseline.py`
   - ä½¿ç”¨subprocessè°ƒç”¨CLI
   - åªä¿å­˜output_hash

2. **ç”ŸæˆCLIä¸“ç”¨åŸºå‡†**
   ```bash
   python tests/e2e/generate_cli_golden_baseline.py
   ```
   - è¾“å‡ºåˆ°`tests/e2e/golden_cli/`ç›®å½•

3. **ä¿®æ”¹CLIé»‘ç›’æµ‹è¯•è¯»å–åŸºå‡†**
   ```python
   # ä¿®æ”¹å‰
   golden_dir = Path(__file__).parent / "golden"
   
   # ä¿®æ”¹å
   golden_dir = Path(__file__).parent / "golden_cli"
   ```

4. **éªŒè¯å®Œå…¨è§£è€¦**
   ```bash
   pytest tests/e2e/test_e2e_cli_blackbox.py -v
   ```

**é¢„æœŸç»“æœ**: è§£è€¦ç¨‹åº¦ä»75%æå‡åˆ°**100%** âœ…

---

## ğŸ“ˆ è§£è€¦ç¨‹åº¦å¯¹æ¯”

### ä¿®æ”¹å‰ (å½“å‰)

| ç»´åº¦ | å¾—åˆ† | è¯´æ˜ |
|------|------|------|
| ä»£ç å¯¼å…¥ | 100% | âœ… ä¸å¯¼å…¥å†…éƒ¨æ¨¡å— |
| APIè°ƒç”¨ | 100% | âœ… ä½¿ç”¨subprocess |
| éªŒè¯é€»è¾‘ | 100% | âœ… åªéªŒè¯å¤–éƒ¨è¡Œä¸º |
| æ•°æ®ä¾èµ– | 0% | âŒ åŸºå‡†ä¾èµ–APIç”Ÿæˆ |
| **æ€»åˆ†** | **75%** | âš ï¸ å­˜åœ¨é—´æ¥è€¦åˆ |

### ä¿®æ”¹å (æ–¹æ¡ˆ1)

| ç»´åº¦ | å¾—åˆ† | è¯´æ˜ |
|------|------|------|
| ä»£ç å¯¼å…¥ | 100% | âœ… ä¸å¯¼å…¥å†…éƒ¨æ¨¡å— |
| APIè°ƒç”¨ | 100% | âœ… ä½¿ç”¨subprocess |
| éªŒè¯é€»è¾‘ | 100% | âœ… åªéªŒè¯å¤–éƒ¨è¡Œä¸º |
| æ•°æ®ä¾èµ– | 100% | âœ… åŸºå‡†é€šè¿‡CLIç”Ÿæˆ |
| **æ€»åˆ†** | **100%** | âœ… å®Œå…¨è§£è€¦ |

---

## ğŸ¯ æ€»ç»“

### å½“å‰çŠ¶æ€

- **è§£è€¦ç¨‹åº¦**: 75% âš ï¸
- **ä¸»è¦é—®é¢˜**: é»„é‡‘åŸºå‡†ä¾èµ–APIç”Ÿæˆ
- **å½±å“**: å­˜åœ¨é—´æ¥è€¦åˆ,ä¸æ˜¯çœŸæ­£çš„é»‘ç›’æµ‹è¯•

### å®Œå…¨è§£è€¦æ–¹æ¡ˆ

- **æ¨èæ–¹æ¡ˆ**: åˆ›å»ºCLIä¸“ç”¨åŸºå‡†ç”Ÿæˆå™¨
- **å®æ–½éš¾åº¦**: ä½ (çº¦30åˆ†é’Ÿ)
- **é¢„æœŸæ•ˆæœ**: è§£è€¦ç¨‹åº¦100% âœ…

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. âœ… åˆ›å»º`generate_cli_golden_baseline.py` (å·²å®Œæˆ)
2. â³ ç”ŸæˆCLIä¸“ç”¨åŸºå‡†
3. â³ ä¿®æ”¹CLIé»‘ç›’æµ‹è¯•è¯»å–CLIåŸºå‡†
4. â³ éªŒè¯100%è§£è€¦

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**åˆ›å»ºæ—¥æœŸ**: 2025-10-09  
**åˆ†æäºº**: PktMask Development Team  
**çŠ¶æ€**: å¾…å®æ–½æ–¹æ¡ˆ1

