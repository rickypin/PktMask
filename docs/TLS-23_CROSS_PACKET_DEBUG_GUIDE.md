# TLS-23跨包长消息掩码调试指南

## 概述

本指南帮助您使用新增的详细调试日志来诊断和定位TLS-23跨包长消息体没有被正确置零的问题。

## 新增调试日志说明

### 🔍 日志标识符

| 标识符 | 组件 | 用途 |
|--------|------|------|
| `🔍 [TLS跨包分析]` | TSharkTLSAnalyzer | TShark分析阶段的跨包检测 |
| `🔍 [TLS-23跨包]` | TSharkTLSAnalyzer | 专门针对TLS-23类型的跨包处理 |
| `🔍 [TLS跨包检测]` | TSharkTLSAnalyzer | 跨包记录的检测和重组 |
| `🔧 [规则生成跨包]` | TLSMaskRuleGenerator | 跨包记录的掩码规则生成 |
| `🔧 [TLS-23跨包规则]` | TLSMaskRuleGenerator | TLS-23跨包掩码规则详情 |
| `🔧 [TLS-23分段规则]` | TLSMaskRuleGenerator | TLS-23分段包掩码规则 |
| `⚡ [TLS-23分段掩码]` | ScapyMaskApplier | TLS-23分段包的掩码应用 |
| `⚡ [TLS-23掩码]` | ScapyMaskApplier | TLS-23常规掩码应用 |
| `⚡ [包级掩码]` | ScapyMaskApplier | 包级别的掩码应用流程 |
| `🚀 [TLS-23跨包处理]` | TSharkEnhancedMaskProcessor | 主流程的TLS-23跨包处理统计 |

## 调试步骤

### 1. 启用详细日志

确保您的日志级别设置为INFO或更详细：

```python
import logging
logging.basicConfig(level=logging.INFO)
```

或在配置文件中设置：

```yaml
# mask_config.yaml
tools:
  tshark_enhanced:
    enable_detailed_logging: true
```

### 2. 运行处理程序

运行您的TLS掩码处理程序，观察控制台输出。

### 3. 按阶段分析日志

#### Stage 1: TShark分析阶段

**查找关键日志**：
```
🚀 [TLS-23跨包处理] 开始Stage 1: TShark TLS分析
🔍 [TLS跨包分析] 检测到分段包 X → 重组到包 Y
🔍 [TLS-23跨包] 发现ApplicationData分段：包X将在包Y中重组
🔍 [TLS跨包分析] 包Y包含重组的TLS记录: 类型=23, 长度=XXXX
🔍 [TLS-23跨包] 重组包Y: ApplicationData长度=XXXX, 需要智能掩码处理
```

**问题排查**：
- 如果没有看到`检测到分段包`日志，说明TShark没有识别到跨包分段
- 如果`ApplicationData长度=0`，说明TShark解析有问题
- 检查`spans_packets`字段是否包含正确的包序列

#### Stage 2: 规则生成阶段

**查找关键日志**：
```
🚀 [TLS-23跨包处理] 开始Stage 2: 掩码规则生成
🔧 [规则生成跨包] 处理跨包记录：包Y, 类型=23, 跨包[X, Y]
🔧 [TLS-23跨包规则] 生成ApplicationData跨包掩码规则:
🔧   包Y: offset=0, total_len=XXXX
🔧   掩码范围: 保留头部5字节, 掩码载荷XXXX字节
🔧   绝对偏移: 5-XXXX
🔧 [TLS-23分段规则] 为分段包X生成分段掩码规则:
🔧   分段包X → 重组到包Y
🔧   掩码策略: 掩码整个TCP载荷 (offset=0, 整个载荷)
```

**问题排查**：
- 检查是否为每个跨包记录都生成了正确的规则
- 确认分段包规则：`offset=0, 整个载荷`
- 确认重组包规则：`保留头部5字节, 掩码载荷X字节`
- 检查`绝对偏移`是否合理

#### Stage 3: 掩码应用阶段

**查找关键日志**：
```
🚀 [TLS-23跨包处理] 开始Stage 3: Scapy掩码应用
⚡ [包级掩码] 包X: 开始应用1个掩码规则，载荷长度=XXXX
⚡ [TLS-23分段掩码] 包X: 分段包掩码规则，掩码整个载荷 0-XXXX
⚡ [TLS-23分段掩码成功] 包X: 整个载荷 0-XXXX, 掩码XXXX字节，所有字节已置零
⚡ [掩码验证] 包X: XXXX/XXXX字节已正确置零
⚡ [包级掩码完成] 包X: 载荷已更新，包已修改
```

**问题排查**：
- 检查`掩码XXXX字节`数量是否符合预期
- 验证`XXXX/XXXX字节已正确置零`的比例是否为100%
- 确认`包已修改`表示掩码确实被应用

### 4. 常见问题诊断

#### 问题1：TShark没有识别跨包分段

**症状**：没有看到`检测到分段包`日志

**可能原因**：
- TShark版本不支持TLS分段检测
- 输入PCAP文件中的TLS分段信息不完整
- TShark命令参数配置问题

**解决方案**：
1. 检查TShark版本：`tshark -v`
2. 验证TShark能力：`tshark -G fields | grep tls.segment`
3. 手动测试TShark命令：
   ```bash
   tshark -r input.pcap -T json -e tls.segment -e tls.reassembled_in -Y "tls"
   ```

#### 问题2：生成的掩码规则不正确

**症状**：`掩码载荷0字节`或`绝对偏移`异常

**可能原因**：
- TLS记录长度解析错误
- 记录偏移量计算错误
- 跨包检测逻辑有误

**解决方案**：
1. 检查TLS记录的`length`字段
2. 验证`record_offset`计算
3. 确认`spans_packets`包含正确的包序列

#### 问题3：掩码没有正确应用

**症状**：`0/XXXX字节已正确置零`或`包保持原样`

**可能原因**：
- 边界检查失败
- TCP载荷提取错误
- 掩码字节值设置问题

**解决方案**：
1. 检查边界验证日志
2. 验证TCP载荷长度
3. 确认掩码字节值设置

## 日志级别配置

### 基础调试（推荐）
```yaml
logging:
  level: INFO
```

### 详细调试
```yaml
logging:
  level: DEBUG
tools:
  tshark_enhanced:
    enable_detailed_logging: true
```

## 示例完整日志流程

```
🚀 [TLS-23跨包处理] 开始Stage 1: TShark TLS分析
🔍 [TLS跨包分析] 检测到分段包 100 → 重组到包 102
🔍 [TLS-23跨包] 发现ApplicationData分段：包100将在包102中重组
🔍 [TLS跨包分析] 包102包含重组的TLS记录: 类型=23, 长度=8192
🔍 [TLS-23跨包] ApplicationData重组完成：跨包[100, 101, 102], 消息体长度=8192, 应掩码载荷部分

🚀 [TLS-23跨包处理] 开始Stage 2: 掩码规则生成
🔧 [TLS-23分段规则] 为分段包100生成分段掩码规则:
🔧   分段包100 → 重组到包102
🔧   掩码策略: 掩码整个TCP载荷 (offset=0, 整个载荷)
🔧 [TLS-23跨包规则] 生成ApplicationData跨包掩码规则:
🔧   包102: offset=0, total_len=8197
🔧   掩码范围: 保留头部5字节, 掩码载荷8192字节
🔧   绝对偏移: 5-8197

🚀 [TLS-23跨包处理] 开始Stage 3: Scapy掩码应用
⚡ [包级掩码] 包100: 开始应用1个掩码规则，载荷长度=1460
⚡ [TLS-23分段掩码] 包100: 分段包掩码规则，掩码整个载荷 0-1460
⚡ [TLS-23分段掩码成功] 包100: 整个载荷 0-1460, 掩码1460字节，所有字节已置零
⚡ [掩码验证] 包100: 1460/1460字节已正确置零
⚡ [包级掩码完成] 包100: 载荷已更新，包已修改

⚡ [包级掩码] 包102: 开始应用1个掩码规则，载荷长度=6737
⚡ [TLS-23掩码] 包102: ApplicationData掩码，保留头部5字节，掩码载荷8192字节
⚡ [TLS-23掩码成功] 包102: 偏移5-6737, 掩码6732字节
⚡ [TLS-23掩码验证] 包102: ApplicationData载荷，6732/6732字节已正确置零
⚡ [包级掩码完成] 包102: 载荷已更新，包已修改

🚀 [TLS-23跨包统计] 掩码应用结果:
🚀   处理包数: 150
🚀   修改包数: 3
🚀   掩码字节数: 8192
```

## 性能影响说明

新增的调试日志会对性能产生一定影响：

- **信息级日志（INFO）**：性能影响<5%，建议在生产环境启用
- **调试级日志（DEBUG）**：性能影响10-20%，仅在故障排查时启用

## 快速排查检查清单

1. ✅ TShark是否识别到跨包分段？（查找`检测到分段包`）
2. ✅ 分段包规则是否正确生成？（查找`分段掩码规则`）
3. ✅ 重组包规则是否正确生成？（查找`跨包掩码规则`）
4. ✅ 分段包掩码是否正确应用？（查找`分段掩码成功`）
5. ✅ 重组包掩码是否正确应用？（查找`掩码成功`）
6. ✅ 掩码字节验证是否通过？（查找`字节已正确置零`）

## 技术支持

如果遇到问题，请收集以下信息：

1. 完整的日志输出（启用INFO级别）
2. 输入PCAP文件的基本信息
3. TShark版本信息
4. 期望的掩码行为描述

通过这些详细的调试日志，您应该能够精确定位TLS-23跨包长消息体掩码处理中的任何问题。 