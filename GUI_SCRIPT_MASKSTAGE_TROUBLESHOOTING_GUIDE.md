# GUI ç•Œé¢ä¸è„šæœ¬è°ƒç”¨ MaskStage ç»“æœä¸ä¸€è‡´é—®é¢˜æ’æŸ¥æŒ‡å—

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

### é—®é¢˜æè¿°
- **ç°è±¡**: ä½¿ç”¨ç›¸åŒè¾“å…¥æ–‡ä»¶æ—¶ï¼ŒGUI ç•Œé¢å’Œè„šæœ¬ `tls23_maskstage_e2e_validator.py` çš„æ‰§è¡Œç»“æœä¸ä¸€è‡´
- **é¢„æœŸè¡Œä¸º**: è„šæœ¬æ‰§è¡Œç»“æœç¬¦åˆé¢„æœŸï¼ˆæ­£ç¡®æ©ç  TLS-23 æ¶ˆæ¯ä½“ï¼‰
- **å¼‚å¸¸è¡Œä¸º**: GUI æ‰§è¡Œç»“æœå¼‚å¸¸ï¼ˆå­˜åœ¨å¤§é‡æœªæ©ç çš„ TLS-23 æ¶ˆæ¯ä½“ï¼‰
- **æµ‹è¯•æ•°æ®**: `tests/data/tls/` ç›®å½•

### å½±å“èŒƒå›´
- å½±å“ GUI ç”¨æˆ·çš„ TLS-23 æ¶ˆæ¯æ©ç åŠŸèƒ½
- å¯èƒ½å¯¼è‡´æ•æ„Ÿæ•°æ®æ³„éœ²é£é™©
- å½±å“å·¥å…·çš„ä¸€è‡´æ€§å’Œå¯é æ€§

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### å…³é”®å‘ç°ï¼šé…ç½®ç»“æ„ä¸åŒ¹é…

é€šè¿‡æ·±å…¥åˆ†æä¸¤ç§è°ƒç”¨æ–¹å¼çš„é…ç½®ä¼ é€’è·¯å¾„ï¼Œå‘ç°äº†**å…³é”®çš„é…ç½®ç»“æ„å·®å¼‚**ï¼š

#### GUI é…ç½®ç»“æ„ï¼ˆâŒ é”™è¯¯ï¼‰
```python
# src/pktmask/services/pipeline_service.py::build_pipeline_config()
"marker_config": {
    "preserve": {                    # âŒ é”™è¯¯çš„åµŒå¥—ç»“æ„
        "handshake": True,
        "application_data": False,   # è¿™ä¸ªé…ç½®æ— æ³•è¢« TLSProtocolMarker è¯»å–ï¼
        "alert": True,
        "change_cipher_spec": True,
        "heartbeat": True
    }
}
```

#### è„šæœ¬é…ç½®ç»“æ„ï¼ˆâœ… æ­£ç¡®ï¼‰
```python
# scripts/validation/tls23_maskstage_e2e_validator.py
"marker_config": {
    "tls": {                        # âœ… æ­£ç¡®çš„åµŒå¥—ç»“æ„
        "preserve_handshake": True,
        "preserve_application_data": False  # è¿™ä¸ªé…ç½®èƒ½è¢«æ­£ç¡®è¯»å–
    }
}
```

#### TLSProtocolMarker çš„é…ç½®è§£æé€»è¾‘
```python
# src/pktmask/core/pipeline/stages/mask_payload_v2/marker/tls_marker.py
def __init__(self, config: Dict[str, Any]):
    # TLSä¿ç•™ç­–ç•¥é…ç½®
    self.preserve_config = config.get('preserve', {
        'handshake': True,
        'application_data': False,      # é»˜è®¤å€¼ï¼šä¸ä¿ç•™å®Œæ•´ ApplicationData
        'alert': True,
        'change_cipher_spec': True,
        'heartbeat': True
    })
```

### é—®é¢˜æœºåˆ¶
1. **GUI è·¯å¾„**: `config['preserve']` â†’ ä½†å®é™…ä¼ å…¥çš„æ˜¯ `config['tls']` â†’ è¯»å–å¤±è´¥ â†’ ä½¿ç”¨é»˜è®¤å€¼
2. **è„šæœ¬è·¯å¾„**: `config['tls']` â†’ ä½† TLSProtocolMarker è¯»å– `config['preserve']` â†’ è¯»å–å¤±è´¥ â†’ ä½¿ç”¨é»˜è®¤å€¼
3. **ç»“æœ**: ä¸¤ç§æ–¹å¼éƒ½æ— æ³•æ­£ç¡®è¯»å–é…ç½®ï¼Œä½†ç”±äºé»˜è®¤å€¼ `application_data=False`ï¼Œè„šæœ¬åº”è¯¥å·¥ä½œæ­£å¸¸

### æ·±å±‚é—®é¢˜
è¿›ä¸€æ­¥åˆ†æå‘ç°ï¼Œå¯èƒ½å­˜åœ¨é…ç½®ä¼ é€’é“¾è·¯ä¸­çš„å…¶ä»–é—®é¢˜ï¼Œéœ€è¦é€šè¿‡ç³»ç»Ÿæ€§æ’æŸ¥æ¥å®šä½ã€‚

## ğŸ› ï¸ æ’æŸ¥å·¥å…·

### 1. é…ç½®å¯¹æ¯”éªŒè¯å·¥å…·
**æ–‡ä»¶**: `config_comparison_tool.py`
**åŠŸèƒ½**: 
- å¯¹æ¯” GUI å’Œè„šæœ¬çš„é…ç½®ç»“æ„
- è¯†åˆ«å…³é”®é…ç½®å·®å¼‚
- ç”Ÿæˆè¯¦ç»†çš„å¯¹æ¯”æŠ¥å‘Š

**ä½¿ç”¨æ–¹æ³•**:
```bash
python config_comparison_tool.py
```

### 2. ä¸­é—´ç»“æœæ£€æŸ¥ç‚¹å·¥å…·
**æ–‡ä»¶**: `config_comparison_tool.py` (MiddlewareCheckpoint ç±»)
**åŠŸèƒ½**:
- æ£€æŸ¥ Stage åˆ›å»ºå’Œé…ç½®ä¼ é€’
- éªŒè¯ Marker åˆå§‹åŒ–è¿‡ç¨‹
- åˆ†æè§„åˆ™ç”Ÿæˆé…ç½®

**ä½¿ç”¨æ–¹æ³•**:
```python
from config_comparison_tool import MiddlewareCheckpoint
checkpoint = MiddlewareCheckpoint(test_file)
results = checkpoint.run_all_checkpoints(config)
```

### 3. è°ƒè¯•æ—¥å¿—å¢å¼ºå·¥å…·
**æ–‡ä»¶**: `debug_logging_enhancer.py`
**åŠŸèƒ½**:
- ä¸ºå…³é”®ç±»æ·»åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—
- è®°å½•é…ç½®ä¼ é€’è¿‡ç¨‹
- è·Ÿè¸ª TLS-23 è§„åˆ™ç”Ÿæˆ

**ä½¿ç”¨æ–¹æ³•**:
```python
from debug_logging_enhancer import enable_debug_logging
debug_logger = enable_debug_logging()
# ç„¶åè¿è¡Œ GUI æˆ–è„šæœ¬
```

## ğŸ¯ æ’æŸ¥ä¼˜å…ˆçº§å’Œæ­¥éª¤

### ä¼˜å…ˆçº§ 1: å…³é”®é…ç½®éªŒè¯ï¼ˆç«‹å³æ‰§è¡Œï¼‰

#### æ­¥éª¤ 1: éªŒè¯é…ç½®ä¼ é€’è·¯å¾„
**é¢„ä¼°æ—¶é—´**: 15åˆ†é’Ÿ
**å·¥å…·**: `config_comparison_tool.py`
**æ“ä½œ**:
```bash
python config_comparison_tool.py
```
**é¢„æœŸç»“æœ**: è¯†åˆ«é…ç½®ç»“æ„å·®å¼‚ï¼Œç¡®è®¤ preserve_config æ˜¯å¦æ­£ç¡®è®¾ç½®

#### æ­¥éª¤ 2: ä¿®å¤é…ç½®ç»“æ„ä¸åŒ¹é…
**é¢„ä¼°æ—¶é—´**: 30åˆ†é’Ÿ
**æ“ä½œ**: åŸºäºæ­¥éª¤1çš„å‘ç°ï¼Œä¿®å¤é…ç½®ç»“æ„
**å…³é”®ä¿®å¤ç‚¹**:

**æ–¹æ¡ˆA: ä¿®å¤ GUI é…ç½®ç»“æ„**
```python
# ä¿®æ”¹ src/pktmask/services/pipeline_service.py::build_pipeline_config()
"marker_config": {
    "application_data": False,  # ç›´æ¥åœ¨é¡¶å±‚ï¼Œè€Œä¸æ˜¯åµŒå¥—åœ¨ preserve ä¸­
    "handshake": True,
    "alert": True,
    "change_cipher_spec": True,
    "heartbeat": True
}
```

**æ–¹æ¡ˆB: ä¿®å¤ TLSProtocolMarker é…ç½®è§£æ**
```python
# ä¿®æ”¹ src/pktmask/core/pipeline/stages/mask_payload_v2/marker/tls_marker.py
def __init__(self, config: Dict[str, Any]):
    # æ”¯æŒå¤šç§é…ç½®ç»“æ„
    if 'preserve' in config:
        self.preserve_config = config['preserve']
    elif 'tls' in config:
        # è½¬æ¢è„šæœ¬æ ¼å¼åˆ°å†…éƒ¨æ ¼å¼
        tls_config = config['tls']
        self.preserve_config = {
            'handshake': tls_config.get('preserve_handshake', True),
            'application_data': tls_config.get('preserve_application_data', False),
            # ... å…¶ä»–å­—æ®µ
        }
    else:
        # ä½¿ç”¨é»˜è®¤é…ç½®
        self.preserve_config = { ... }
```

### ä¼˜å…ˆçº§ 2: ä¸­é—´ç»“æœéªŒè¯

#### æ­¥éª¤ 3: Stage åˆ›å»ºå’Œåˆå§‹åŒ–éªŒè¯
**é¢„ä¼°æ—¶é—´**: 20åˆ†é’Ÿ
**ä¾èµ–**: æ­¥éª¤2å®Œæˆ
**æ“ä½œ**: ä½¿ç”¨ MiddlewareCheckpoint éªŒè¯ä¿®å¤æ•ˆæœ

#### æ­¥éª¤ 4: è§„åˆ™ç”Ÿæˆè¿‡ç¨‹éªŒè¯
**é¢„ä¼°æ—¶é—´**: 25åˆ†é’Ÿ
**æ“ä½œ**: éªŒè¯ TLS-23 è§„åˆ™ç”Ÿæˆé€»è¾‘

### ä¼˜å…ˆçº§ 3: ç«¯åˆ°ç«¯æµ‹è¯•

#### æ­¥éª¤ 5: å•æ–‡ä»¶å¯¹æ¯”æµ‹è¯•
**é¢„ä¼°æ—¶é—´**: 20åˆ†é’Ÿ
**æ“ä½œ**: ä½¿ç”¨ç›¸åŒæµ‹è¯•æ–‡ä»¶å¯¹æ¯”å¤„ç†ç»“æœ

#### æ­¥éª¤ 6: TLS-23 æ¶ˆæ¯ä½“æ©ç éªŒè¯
**é¢„ä¼°æ—¶é—´**: 15åˆ†é’Ÿ
**æ“ä½œ**: ä½¿ç”¨ tls23_marker éªŒè¯æ©ç æ•ˆæœ

## ğŸš€ å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ

### ç«‹å³å¯æ‰§è¡Œçš„ä¿®å¤

åŸºäºåˆ†æï¼Œæ¨è**æ–¹æ¡ˆA**ï¼ˆä¿®å¤ GUI é…ç½®ç»“æ„ï¼‰ï¼Œå› ä¸ºï¼š
1. å½±å“èŒƒå›´å°ï¼Œåªéœ€ä¿®æ”¹ä¸€ä¸ªæ–‡ä»¶
2. ä¿æŒè„šæœ¬é…ç½®ä¸å˜ï¼Œé™ä½å›å½’é£é™©
3. ç¬¦åˆ TLSProtocolMarker çš„é¢„æœŸé…ç½®æ ¼å¼

### ä¿®å¤æ­¥éª¤
1. å¤‡ä»½ `src/pktmask/services/pipeline_service.py`
2. ä¿®æ”¹ `build_pipeline_config()` å‡½æ•°ä¸­çš„ `marker_config` ç»“æ„
3. è¿è¡Œé…ç½®å¯¹æ¯”å·¥å…·éªŒè¯ä¿®å¤æ•ˆæœ
4. ä½¿ç”¨æµ‹è¯•æ–‡ä»¶éªŒè¯ GUI å’Œè„šæœ¬ç»“æœä¸€è‡´æ€§

## ğŸ“Š éªŒè¯æ–¹æ³•

### é…ç½®ä¸€è‡´æ€§éªŒè¯
```bash
python config_comparison_tool.py
# æœŸæœ›è¾“å‡º: "âœ… é…ç½®å®Œå…¨ä¸€è‡´"
```

### åŠŸèƒ½éªŒè¯
```bash
# 1. GUI å¤„ç†æµ‹è¯•æ–‡ä»¶
# 2. è„šæœ¬å¤„ç†ç›¸åŒæ–‡ä»¶
python scripts/validation/tls23_maskstage_e2e_validator.py --input-dir tests/data/tls/

# 3. å¯¹æ¯”è¾“å‡ºæ–‡ä»¶
diff gui_output.pcap script_output.pcap
```

### TLS-23 æ©ç éªŒè¯
```bash
# éªŒè¯å¤„ç†åçš„æ–‡ä»¶
python -m pktmask.tools.tls23_marker --pcap processed_file.pcap --formats json
# æ£€æŸ¥ JSON è¾“å‡ºä¸­ TLS-23 æ¶ˆæ¯çš„æ©ç çŠ¶æ€
```

## ğŸ“ é¢„æœŸç»“æœ

ä¿®å¤å®Œæˆåï¼Œåº”è¯¥è¾¾åˆ°ï¼š
1. **é…ç½®ä¸€è‡´æ€§**: GUI å’Œè„šæœ¬ä½¿ç”¨ç›¸åŒçš„é…ç½®ç»“æ„
2. **å¤„ç†ç»“æœä¸€è‡´**: ç›¸åŒè¾“å…¥æ–‡ä»¶äº§ç”Ÿç›¸åŒè¾“å‡º
3. **TLS-23 æ­£ç¡®æ©ç **: åªä¿ç•™5å­—èŠ‚å¤´éƒ¨ï¼Œå…¶ä½™éƒ¨åˆ†è¢«æ©ç 
4. **å›å½’æµ‹è¯•é€šè¿‡**: æ‰€æœ‰æµ‹è¯•æ–‡ä»¶å¤„ç†æ­£å¸¸

## ğŸ”§ æ•…éšœæ’é™¤

å¦‚æœå¿«é€Ÿä¿®å¤æ–¹æ¡ˆæ— æ•ˆï¼ŒæŒ‰ä¼˜å…ˆçº§æ‰§è¡Œå®Œæ•´æ’æŸ¥æµç¨‹ï¼š
1. å¯ç”¨è¯¦ç»†è°ƒè¯•æ—¥å¿—
2. åˆ†æä»£ç è·¯å¾„å·®å¼‚
3. æ£€æŸ¥å¼‚æ­¥å¤„ç†å½±å“
4. éªŒè¯ Masker æ¨¡å—è¡Œä¸ºä¸€è‡´æ€§

## ğŸ“ æ”¯æŒä¿¡æ¯

- **æ’æŸ¥å·¥å…·**: æœ¬ç›®å½•ä¸‹çš„ Python è„šæœ¬
- **æµ‹è¯•æ•°æ®**: `tests/data/tls/` ç›®å½•
- **å…³é”®æ–‡ä»¶**:
  - `src/pktmask/services/pipeline_service.py`
  - `src/pktmask/core/pipeline/stages/mask_payload_v2/marker/tls_marker.py`
  - `scripts/validation/tls23_maskstage_e2e_validator.py`

## ğŸ“ˆ å®æ–½æ—¶é—´çº¿

### é˜¶æ®µ1: ç´§æ€¥ä¿®å¤ï¼ˆ1å°æ—¶å†…ï¼‰
- [ ] è¿è¡Œé…ç½®å¯¹æ¯”å·¥å…·
- [ ] å®æ–½é…ç½®ç»“æ„ä¿®å¤
- [ ] åŸºæœ¬åŠŸèƒ½éªŒè¯

### é˜¶æ®µ2: å…¨é¢éªŒè¯ï¼ˆ2å°æ—¶å†…ï¼‰
- [ ] ä¸­é—´ç»“æœæ£€æŸ¥
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] å›å½’æµ‹è¯•

### é˜¶æ®µ3: æ·±åº¦æ’æŸ¥ï¼ˆå¦‚éœ€è¦ï¼Œ4å°æ—¶å†…ï¼‰
- [ ] è¯¦ç»†è°ƒè¯•æ—¥å¿—åˆ†æ
- [ ] ä»£ç è·¯å¾„å·®å¼‚åˆ†æ
- [ ] æ€§èƒ½å’Œç¨³å®šæ€§æµ‹è¯•

## ğŸ¯ æˆåŠŸæ ‡å‡†

ä¿®å¤è¢«è®¤ä¸ºæˆåŠŸå½“ä¸”ä»…å½“ï¼š
1. âœ… é…ç½®å¯¹æ¯”å·¥å…·æ˜¾ç¤º"é…ç½®å®Œå…¨ä¸€è‡´"
2. âœ… ç›¸åŒè¾“å…¥æ–‡ä»¶é€šè¿‡ GUI å’Œè„šæœ¬å¤„ç†äº§ç”Ÿå­—èŠ‚çº§ç›¸åŒçš„è¾“å‡º
3. âœ… TLS-23 æ¶ˆæ¯ä½“æ­£ç¡®æ©ç ï¼ˆåªä¿ç•™5å­—èŠ‚å¤´éƒ¨ï¼‰
4. âœ… æ‰€æœ‰æµ‹è¯•æ–‡ä»¶çš„å›å½’æµ‹è¯•é€šè¿‡
5. âœ… ä¸å½±å“å…¶ä»– TLS æ¶ˆæ¯ç±»å‹çš„å¤„ç†

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**åˆ›å»ºæ—¶é—´**: åŸºäºè¯¦ç»†æµç¨‹åˆ†æç”Ÿæˆ
**é€‚ç”¨èŒƒå›´**: PktMask GUI ç•Œé¢å’Œè„šæœ¬è°ƒç”¨ MaskStage ç»“æœä¸ä¸€è‡´é—®é¢˜
