#!/bin/bash

# Pre-commit hook to check for Chinese characters in staged files
# This enforces the English-Only Coding Policy for PktMask project
#
# Installation:
#   cp scripts/git-hooks/pre-commit-chinese-check .git/hooks/pre-commit
#   chmod +x .git/hooks/pre-commit
#
# Or use the install script:
#   scripts/git-hooks/install-hooks.sh

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
CHINESE_PATTERN='[\u4e00-\u9fff]'
CHECKED_EXTENSIONS='\.(py|md|txt|yml|yaml|json|toml|cfg|ini)$'

# Excluded files (can contain Chinese text)
EXCLUDED_FILES=(
    "CHANGELOG.md"
    "CONTRIBUTORS.md"
    "tests/fixtures/.*"
    "tests/data/.*"
)

echo -e "${BLUE}üîç Checking staged files for Chinese characters...${NC}"

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}‚úÖ No staged files to check${NC}"
    exit 0
fi

# Filter files by extension
RELEVANT_FILES=""
for file in $STAGED_FILES; do
    if [[ $file =~ $CHECKED_EXTENSIONS ]]; then
        # Check if file should be excluded
        EXCLUDE_FILE=false
        for excluded in "${EXCLUDED_FILES[@]}"; do
            if [[ $file =~ $excluded ]]; then
                EXCLUDE_FILE=true
                break
            fi
        done
        
        if [ "$EXCLUDE_FILE" = false ]; then
            RELEVANT_FILES="$RELEVANT_FILES $file"
        fi
    fi
done

if [ -z "$RELEVANT_FILES" ]; then
    echo -e "${GREEN}‚úÖ No relevant files to check${NC}"
    exit 0
fi

echo -e "${BLUE}üìÅ Checking files: $(echo $RELEVANT_FILES | wc -w) files${NC}"

# Check for Chinese characters
ISSUES_FOUND=false
TOTAL_ISSUES=0

for file in $RELEVANT_FILES; do
    if [ ! -f "$file" ]; then
        continue
    fi
    
    # Use git show to get staged content
    CHINESE_LINES=$(git show ":$file" | grep -n "$CHINESE_PATTERN" || true)
    
    if [ ! -z "$CHINESE_LINES" ]; then
        if [ "$ISSUES_FOUND" = false ]; then
            echo -e "\n${RED}‚ùå Chinese characters found in staged files:${NC}"
            echo -e "${RED}================================================${NC}"
            ISSUES_FOUND=true
        fi
        
        echo -e "\n${YELLOW}üìÑ File: $file${NC}"
        
        # Process each line with Chinese characters
        while IFS= read -r line; do
            if [ ! -z "$line" ]; then
                LINE_NUM=$(echo "$line" | cut -d: -f1)
                LINE_CONTENT=$(echo "$line" | cut -d: -f2-)
                
                # Extract Chinese characters
                CHINESE_CHARS=$(echo "$LINE_CONTENT" | grep -o "$CHINESE_PATTERN" | tr '\n' ' ')
                
                echo -e "  ${RED}Line $LINE_NUM:${NC} $LINE_CONTENT"
                echo -e "  ${RED}Chinese text:${NC} $CHINESE_CHARS"
                
                TOTAL_ISSUES=$((TOTAL_ISSUES + 1))
            fi
        done <<< "$CHINESE_LINES"
    fi
done

if [ "$ISSUES_FOUND" = true ]; then
    echo -e "\n${RED}================================================${NC}"
    echo -e "${RED}‚ùå COMMIT REJECTED: Found $TOTAL_ISSUES Chinese text issues${NC}"
    echo -e "\n${YELLOW}üìã Required Actions:${NC}"
    echo -e "1. Translate all Chinese text to English"
    echo -e "2. Follow the English-Only Coding Policy: docs/dev/ENGLISH_ONLY_CODING_POLICY.md"
    echo -e "3. Use technical terminology from the translation guide"
    echo -e "4. Ensure docstrings follow PEP 257 conventions"
    echo -e "\n${YELLOW}üîß Translation Guidelines:${NC}"
    echo -e "‚Ä¢ ÂéªÈáç ‚Üí Deduplication"
    echo -e "‚Ä¢ ÂåøÂêçÂåñ ‚Üí Anonymization" 
    echo -e "‚Ä¢ ËΩΩËç∑Êé©Á†Å ‚Üí Payload Masking"
    echo -e "‚Ä¢ Â∫èÂàóÂè∑ ‚Üí Sequence Number"
    echo -e "‚Ä¢ ‰øùÁïôËßÑÂàô ‚Üí Keep Rules"
    echo -e "‚Ä¢ ÁªüËÆ°‰ø°ÊÅØ ‚Üí Statistics"
    echo -e "‚Ä¢ ÈîôËØØÊÅ¢Â§ç ‚Üí Error Recovery"
    echo -e "‚Ä¢ ÊÄßËÉΩÁõëÊéß ‚Üí Performance Monitoring"
    echo -e "‚Ä¢ ËµÑÊ∫êÊ∏ÖÁêÜ ‚Üí Resource Cleanup"
    echo -e "\n${YELLOW}üõ†Ô∏è  Tools Available:${NC}"
    echo -e "‚Ä¢ Run: python scripts/maintenance/check_chinese_text.py --report"
    echo -e "‚Ä¢ Review: docs/dev/CHINESE_DOCUMENTATION_TRANSLATION_CATALOG.md"
    echo -e "\n${RED}Please fix these issues and commit again.${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Language compliance check passed - no Chinese characters found${NC}"
echo -e "${GREEN}üéâ All staged files comply with English-Only Coding Policy${NC}"
exit 0
