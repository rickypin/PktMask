# 场景7：综合测试场景
# 目标：综合测试多个流、多种掩码策略的复杂组合

metadata:
  name: "综合测试场景"
  description: "综合测试双向流、多种协议类型、不同保留策略的复杂组合"
  expected_modified_packets: 6
  expected_masked_bytes: 1150  # 多个包的掩码字节总和
  expected_kept_bytes: 45      # 各种保留策略的字节总和
  test_type: "comprehensive"

keep_range_rules:
  # 正向流：TLS握手包保留策略
  - stream_id: "TCP_10.171.250.80:33492_10.50.50.161:443_forward"
    sequence_start: 2422049782
    sequence_end: 2422050299
    keep_ranges:
      - [0, 5]   # TLS记录头
      - [5, 9]   # 握手消息头
    protocol_hint: "TLS_ClientHello"
  
  # 正向流：应用数据最小保留
  - stream_id: "TCP_10.171.250.80:33492_10.50.50.161:443_forward"
    sequence_start: 2422050425
    sequence_end: 2422050630
    keep_ranges:
      - [0, 5]   # 仅保留记录头
    protocol_hint: "TLS_ApplicationData"
  
  # 正向流：Change Cipher Spec完全保留（短消息）
  - stream_id: "TCP_10.171.250.80:33492_10.50.50.161:443_forward"
    sequence_start: 2422050630
    sequence_end: 2422050636
    keep_ranges:
      - [0, 6]   # 完全保留短消息
    protocol_hint: "TLS_ChangeCipherSpec"
  
  # 反向流：服务器握手响应保留
  - stream_id: "TCP_10.171.250.80:33492_10.50.50.161:443_reverse"
    sequence_start: 3913402950
    sequence_end: 3913404815
    keep_ranges:
      - [0, 5]   # TLS记录头
      - [5, 9]   # 握手消息头
    protocol_hint: "TLS_ServerHello"
  
  # 反向流：应用数据响应
  - stream_id: "TCP_10.171.250.80:33492_10.50.50.161:443_reverse"
    sequence_start: 3913404815
    sequence_end: 3913404926
    keep_ranges:
      - [0, 5]   # 仅保留记录头
    protocol_hint: "TLS_ApplicationData"
  
  # 反向流：Alert消息
  - stream_id: "TCP_10.171.250.80:33492_10.50.50.161:443_reverse"
    sequence_start: 3913404942
    sequence_end: 3913404957
    keep_ranges:
      - [0, 7]   # 保留完整Alert
    protocol_hint: "TLS_Alert"

verification:
  target_packets: [4, 5, 13, 14, 15, 20]  # 多个关键包
  flow_validation:
    forward_flow: "TCP_10.171.250.80:33492_10.50.50.161:443_forward"
    reverse_flow: "TCP_10.171.250.80:33492_10.50.50.161:443_reverse"
    flow_independence: "验证两个流的独立处理"
  
  protocol_coverage:
    handshake: "ClientHello, ServerHello"
    application_data: "双向应用数据交换"
    control_messages: "ChangeCipherSpec, Alert"
  
  strategy_coverage:
    minimal_preserve: "应用数据包"
    header_preserve: "握手包"
    full_preserve: "控制消息包"

performance_requirements:
  max_processing_time: "< 2秒"
  memory_usage: "< 50MB"
  accuracy_rate: "> 95%"

integration_test:
  bidirectional: true
  multi_protocol: true
  complex_masking: true
  real_world_simulation: true 