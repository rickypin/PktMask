# 场景6：混合协议测试
# 目标：验证对不同类型TLS包的混合处理策略

metadata:
  name: "混合协议测试"
  description: "验证对不同类型TLS包（握手、应用数据、警告）应用不同掩码策略"
  expected_modified_packets: 3
  expected_masked_bytes: 620   # ClientHello(512) + ApplicationData(200) + Alert(partial)
  expected_kept_bytes: 25      # 各包头部保留字节总和
  test_type: "mixed_protocols"

keep_range_rules:
  # TLS ClientHello - 保留握手消息头
  - stream_id: "TCP_10.171.250.80:33492_10.50.50.161:443_forward"
    sequence_start: 2422049782
    sequence_end: 2422050299
    keep_ranges:
      - [0, 5]   # TLS记录头
      - [5, 9]   # 握手消息头 (Type + Length)
    protocol_hint: "TLS_Handshake"
  
  # TLS ApplicationData - 只保留记录头
  - stream_id: "TCP_10.171.250.80:33492_10.50.50.161:443_forward"
    sequence_start: 2422050425
    sequence_end: 2422050630
    keep_ranges:
      - [0, 5]   # 只保留TLS记录头
    protocol_hint: "TLS_ApplicationData"
  
  # TLS Alert - 保留完整Alert消息（短消息）
  - stream_id: "TCP_10.171.250.80:33492_10.50.50.161:443_reverse"
    sequence_start: 3913404942
    sequence_end: 3913404957  # Alert包通常很短
    keep_ranges:
      - [0, 7]   # 保留完整Alert消息（记录头+Alert内容）
    protocol_hint: "TLS_Alert"

verification:
  target_packets: [4, 14, 20]  # ClientHello, ApplicationData, Alert
  unchanged_packets: [1, 2, 3, 5, 6, 7, 8, 9, 10, 11, 12, 13, 15, 16, 17, 18, 19, 21, 22]
  modified_payload_check:
    packet_4:
      bytes_0_to_8: "unchanged"    # TLS记录头+握手消息头保持
      bytes_9_to_516: "masked"     # 握手消息体掩码
    packet_14:
      bytes_0_to_4: "unchanged"    # TLS记录头保持
      bytes_5_to_204: "masked"     # 应用数据掩码
    packet_20:
      bytes_0_to_6: "unchanged"    # Alert消息完整保留
      bytes_7_to_end: "masked"     # 超出部分掩码

strategy_validation:
  handshake_strategy: "preserve_headers"
  application_data_strategy: "minimal_preserve"
  alert_strategy: "full_preserve"
  rationale: "不同协议类型需要不同的保护策略以平衡安全性和功能性" 