# æ—§"stages"ç›®å½•ä¸æ–°"pipeline/stages"ç›®å½•æ•´åˆå®æ–½æ€»ç»“

## å®æ–½çŠ¶æ€ï¼šâœ… ç¬¬ä¸€é˜¶æ®µå®Œæˆ

### å·²å®Œæˆçš„å·¥ä½œ

#### 1. åˆ›å»ºè¿ç§»æ˜ å°„ âœ…
- **ä¿®æ”¹ `stages/__init__.py`** ä¸ºè¿ç§»å±‚ï¼Œé‡å®šå‘åˆ°æ–°å®ç°
- **æ·»åŠ åºŸå¼ƒè­¦å‘Š** æé†’å¼€å‘è€…è¿ç§»åˆ°æ–°æ¶æ„
- **ä¿æŒå®Œå…¨å…¼å®¹æ€§** æ‰€æœ‰ç°æœ‰å¯¼å…¥è·¯å¾„ç»§ç»­å·¥ä½œ

#### 2. åˆ›å»ºå…¼å®¹æ€§é€‚é…å™¨ âœ…
- **DeduplicationStageCompat** åŒ…è£… `DedupStage` æä¾›æ—§æ¥å£
- **IpAnonymizationStageCompat** åŒ…è£… `AnonStage` æä¾›æ—§æ¥å£
- **æ™ºèƒ½ç»“æœè½¬æ¢** è‡ªåŠ¨è½¬æ¢ `StageStats` ä¸ºæ—§æ ¼å¼å­—å…¸
- **æ–¹æ³•å…¼å®¹æ€§** ä¿æŒæ‰€æœ‰æ—§æ–¹æ³•ç­¾åå’Œè¡Œä¸º

#### 3. æ ‡è®°æ—§å®ç°ä¸ºåºŸå¼ƒ âœ…
- **æ·»åŠ åºŸå¼ƒè­¦å‘Š** åœ¨æ—§çš„ `deduplication.py` å’Œ `ip_anonymization.py`
- **ä¿ç•™ä»£ç ** ä½†æ ‡è®°ä¸ºåºŸå¼ƒï¼Œç¡®ä¿è¿‡æ¸¡æœŸç¨³å®šæ€§
- **æ–‡æ¡£æ›´æ–°** æŒ‡å‘æ–°çš„å®ç°è·¯å¾„

### æŠ€æœ¯å®ç°ç»†èŠ‚

#### è¿ç§»æ˜ å°„æ¶æ„
```python
# src/pktmask/stages/__init__.py
warnings.warn("pktmask.stages å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ pktmask.core.pipeline.stages æ›¿ä»£ã€‚")

# é‡å®šå‘åˆ°å…¼å®¹æ€§é€‚é…å™¨
from .adapters.dedup_compat import DeduplicationStageCompat as DeduplicationStage
from .adapters.anon_compat import IpAnonymizationStageCompat as IpAnonymizationStage
```

#### å…¼å®¹æ€§é€‚é…å™¨è®¾è®¡
- **åŒ…è£…æ¨¡å¼** - é€‚é…å™¨åŒ…è£…æ–°å®ç°ï¼Œæä¾›æ—§æ¥å£
- **è‡ªåŠ¨è½¬æ¢** - `StageStats` â†’ æ—§æ ¼å¼ `Dict`
- **æ–¹æ³•æ˜ å°„** - ä¿æŒæ‰€æœ‰æ—§æ–¹æ³•çš„ç­¾åå’Œè¡Œä¸º
- **è­¦å‘Šæœºåˆ¶** - åœ¨ä½¿ç”¨åºŸå¼ƒåŠŸèƒ½æ—¶å‘å‡ºè­¦å‘Š

#### ç»“æœè½¬æ¢é€»è¾‘
```python
# å°†æ–°çš„ StageStats è½¬æ¢ä¸ºæ—§æ ¼å¼
def convert_result(stage_stats):
    return {
        'subdir': extract_from_path(input_path),
        'input_filename': os.path.basename(input_path),
        'output_filename': os.path.basename(output_path),
        'total_packets': stage_stats.packets_processed,
        'unique_packets': stage_stats.packets_processed - stage_stats.packets_modified,
        'removed_count': stage_stats.packets_modified,
    }
```

### éªŒè¯ç»“æœ

#### åŠŸèƒ½éªŒè¯ âœ…
```bash
# å…¼å®¹å±‚æ­£å¸¸å·¥ä½œ
å…¼å®¹å±‚å¯¼å…¥æˆåŠŸ
DeduplicationStage åˆ›å»ºæˆåŠŸï¼Œåç§°: Remove Dupes
IpAnonymizationStage åˆ›å»ºæˆåŠŸï¼Œåç§°: Mask IP

# ç»§æ‰¿å…³ç³»æ­£ç¡®
DeduplicationStage ç»§æ‰¿è‡ª ProcessingStep: True
DeduplicationStage ç»§æ‰¿è‡ª StageBase: True

# åºŸå¼ƒè­¦å‘Šæ­£å¸¸æ˜¾ç¤º
DeprecationWarning: pktmask.stages å·²åºŸå¼ƒï¼Œè¯·ä½¿ç”¨ pktmask.core.pipeline.stages æ›¿ä»£ã€‚
```

#### å‘åå…¼å®¹æ€§ âœ…
- âœ… **å¯¼å…¥è·¯å¾„** - æ‰€æœ‰ç°æœ‰å¯¼å…¥ç»§ç»­å·¥ä½œ
- âœ… **æ¥å£å…¼å®¹** - æ–¹æ³•ç­¾åå’Œè¡Œä¸ºä¿æŒä¸€è‡´
- âœ… **è¿”å›å€¼å…¼å®¹** - ç»“æœæ ¼å¼è‡ªåŠ¨è½¬æ¢
- âœ… **æ„é€ å‡½æ•°å…¼å®¹** - æ”¯æŒæ—§çš„å‚æ•°ç­¾å

### ç›®å½•ç»“æ„å˜åŒ–

#### ä¹‹å‰
```
src/pktmask/
â”œâ”€ steps/           # å·²åºŸå¼ƒçš„åˆ«å
â”œâ”€ stages/          # æ—§çš„ ProcessingStep å®ç°
â””â”€ core/pipeline/stages/  # æ–°çš„ StageBase å®ç°
```

#### ç°åœ¨
```
src/pktmask/
â”œâ”€ steps/           # åºŸå¼ƒåˆ«åï¼ˆä¿ç•™ï¼‰
â”œâ”€ stages/          # è¿ç§»å±‚ + å…¼å®¹é€‚é…å™¨
â”‚  â”œâ”€ __init__.py   # è¿ç§»æ˜ å°„
â”‚  â”œâ”€ adapters/     # å…¼å®¹æ€§é€‚é…å™¨
â”‚  â”œâ”€ deduplication.py    # åºŸå¼ƒå®ç°ï¼ˆæ ‡è®°åºŸå¼ƒï¼‰
â”‚  â””â”€ ip_anonymization.py # åºŸå¼ƒå®ç°ï¼ˆæ ‡è®°åºŸå¼ƒï¼‰
â””â”€ core/pipeline/stages/  # æ–°å®ç°ï¼ˆä¸»è¦ï¼‰
```

### å¤„ç†çš„ä¸‰ç§ Stage å¯¹æ¯”

| æ—§å®ç° | æ–°å®ç° | å…¼å®¹çŠ¶æ€ |
|--------|--------|----------|
| `DeduplicationStage` | `DedupStage` | âœ… å·²é€‚é… |
| `IpAnonymizationStage` | `AnonStage` | âœ… å·²é€‚é… |
| `IntelligentTrimmingStage` | âŒ æ— å¯¹åº” | ğŸ”„ ä¿ç•™åŸå®ç° |

### æ•ˆæœè¯„ä¼°

#### ç«‹å³æ”¶ç›Š âœ…
1. **æ¦‚å¿µç»Ÿä¸€** - æ¶ˆé™¤ä¸‰å¥—å¹¶è¡Œ Stage ç›®å½•çš„æ··æ·†
2. **å¹³æ»‘è¿ç§»** - ç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹ç»§ç»­å·¥ä½œ
3. **æ¸…æ™°åºŸå¼ƒè·¯å¾„** - å¼€å‘è€…äº†è§£è¿ç§»æ–¹å‘

#### æŠ€æœ¯æ”¹è¿› âœ…
1. **ç»Ÿä¸€æ¶æ„** - æ‰€æœ‰ Stage æœ€ç»ˆä½¿ç”¨ `StageBase`
2. **ç°ä»£åŒ–å®ç°** - åˆ©ç”¨æ–°çš„å¤„ç†å™¨æ¶æ„ä¼˜åŠ¿
3. **ç®€åŒ–ç»´æŠ¤** - å‡å°‘é‡å¤ä»£ç å’Œæ¦‚å¿µæ··æ·†

#### å…¼å®¹æ€§ä¿è¯ âœ…
1. **é›¶ç ´åæ€§å˜æ›´** - æ‰€æœ‰ç°æœ‰ä»£ç ç»§ç»­å·¥ä½œ
2. **æ¸è¿›å¼è­¦å‘Š** - å‹å¥½æç¤ºå¼€å‘è€…è¿ç§»
3. **å®Œå…¨åŠŸèƒ½å¯¹ç­‰** - å…¼å®¹å±‚æä¾›å®Œæ•´çš„æ—§åŠŸèƒ½

## ä¸‹ä¸€æ­¥è®¡åˆ’

### çŸ­æœŸï¼ˆ1-2 å‘¨ï¼‰
- [ ] ä¸º `IntelligentTrimmingStage` åˆ›å»ºå¯¹åº”çš„æ–°å®ç°
- [ ] æµ‹è¯•æ›´å¤šå¤æ‚ä½¿ç”¨åœºæ™¯çš„å…¼å®¹æ€§
- [ ] æ›´æ–°å¼€å‘æ–‡æ¡£å’Œè¿ç§»æŒ‡å—

### ä¸­æœŸï¼ˆ1 ä¸ªæœˆï¼‰
- [ ] é¼“åŠ±å¼€å‘è€…ç›´æ¥ä½¿ç”¨æ–°çš„ `core/pipeline/stages/`
- [ ] æ”¶é›†ç¤¾åŒºåé¦ˆï¼Œæ”¹è¿›å…¼å®¹æ€§
- [ ] åˆ›å»ºè‡ªåŠ¨åŒ–è¿ç§»å·¥å…·

### é•¿æœŸï¼ˆ2-3 ä¸ªæœˆï¼‰
- [ ] è¯„ä¼°æ˜¯å¦å¯ä»¥ç§»é™¤å…¼å®¹å±‚
- [ ] å®Œå…¨æ¸…ç†æ—§çš„ `stages/` å®ç°
- [ ] ç»Ÿä¸€æ‰€æœ‰æ–‡æ¡£å’Œç¤ºä¾‹åˆ°æ–°æ¶æ„

## é£é™©ç®¡æ§

### å·²é™ä½çš„é£é™© âœ…
- **ç ´åæ€§å˜æ›´** - é€šè¿‡å…¼å®¹å±‚å®Œå…¨é¿å…
- **åŠŸèƒ½ç¼ºå¤±** - é€šè¿‡é€‚é…å™¨ä¿è¯åŠŸèƒ½å¯¹ç­‰
- **è¿ç§»å›°éš¾** - é€šè¿‡æ¸è¿›å¼è­¦å‘Šé™ä½å¤æ‚åº¦

### æŒç»­ç›‘æ§
- ç¤¾åŒºä½¿ç”¨åé¦ˆ
- å…¼å®¹æ€§é—®é¢˜æŠ¥å‘Š
- æ€§èƒ½å½±å“è¯„ä¼°

## ç»“è®º

ç¬¬ä¸€é˜¶æ®µçš„æ•´åˆå·¥ä½œæˆåŠŸå®Œæˆï¼Œå®ç°äº†ï¼š
- âœ… **é›¶ç ´åæ€§å˜æ›´** - æ‰€æœ‰ç°æœ‰ä»£ç ç»§ç»­å·¥ä½œ
- âœ… **ç›®å½•ç»Ÿä¸€** - æ¶ˆé™¤ä¸‰å¥—å¹¶è¡Œç›®å½•çš„æ··æ·†
- âœ… **å¹³æ»‘è¿ç§»è·¯å¾„** - ä¸ºæœªæ¥å®Œå…¨ç»Ÿä¸€å¥ å®šåŸºç¡€

è¿™ä¸ªè§£å†³æ–¹æ¡ˆé€šè¿‡å…¼å®¹æ€§é€‚é…å™¨é¿å…äº†å¤æ‚çš„ä»£ç åˆå¹¶ï¼Œç¡®ä¿äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
