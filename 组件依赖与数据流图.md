# PktMask ç»„ä»¶ä¾èµ–ä¸æ•°æ®æµå›¾

> **ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¶é—´**: 2025-07-XX  
> **ä½œè€…**: Agentåˆ†æ  
> **è¯´æ˜**: ä»¥"Stage/Processor"ä¸ºèŠ‚ç‚¹çš„å®Œæ•´æ¶æ„æµå›¾ï¼Œè¦†ç›–ä¸¤ç§æ¨¡å¼åŠé™çº§è·¯å¾„

---

## ğŸ—ï¸ æ•´ä½“æ¶æ„æ¦‚è§ˆ

```
PktMask ç³»ç»Ÿæ¶æ„
â”œâ”€â”€ Pipelineæ¨¡å¼ (æ–°æ¶æ„)
â”‚   â”œâ”€â”€ Processor Adapter Mode (é»˜è®¤)
â”‚   â””â”€â”€ Basic Mode (é™çº§)
â”œâ”€â”€ Directè°ƒç”¨æ¨¡å¼ (æ—§æ¶æ„ä¿ç•™)
â””â”€â”€ GUIè°ƒç”¨æ¨¡å¼ (ProcessorRegistryæ¡¥æ¥)
```

---

## ğŸ“Š æ¨¡å¼1: Pipelineæ¶æ„ - Processor Adapter Mode (é»˜è®¤)

### ä¸»é“¾è·¯æµç¨‹å›¾

```mermaid
graph TD
    %% === è¾“å…¥å±‚ ===
    A[ç”¨æˆ·è¾“å…¥æ–‡ä»¶<br/>PCAP/PCAPNG] --> B[PipelineExecutor]
    
    %% === Pipelineé…ç½® ===
    B --> C{é…ç½®æ£€æŸ¥}
    C -->|dedup.enabled=true| D[DedupStage]
    C -->|anon.enabled=true| E[AnonStage] 
    C -->|mask.enabled=true| F[MaskStage]
    
    %% === DedupStage ===
    D --> D1[Deduplicator<br/>Processor]
    D1 --> D2[Scapy rdpcap]
    D2 --> D3[å“ˆå¸Œå»é‡ç®—æ³•]
    D3 --> D4[Scapy wrpcap]
    D4 --> D5[StageStats<br/>å»é‡ç»Ÿè®¡]
    
    %% === AnonStage ===
    D5 --> E
    E --> E1[IPAnonymizer<br/>Processor]
    E1 --> E2[HierarchicalAnonymization<br/>Strategy]
    E2 --> E3[IPåœ°å€æ˜ å°„è¡¨]
    E3 --> E4[ScapyåŒ…ä¿®æ”¹]
    E4 --> E5[StageStats<br/>åŒ¿ååŒ–ç»Ÿè®¡]
    
    %% === MaskStage (Processor Adapter Mode) ===
    E5 --> F
    F --> F1{modeæ£€æŸ¥}
    F1 -->|processor_adapter| G[ProcessorStageAdapter]
    
    %% === TSharkEnhancedMaskProcessor ä¸‰é˜¶æ®µé“¾è·¯ ===
    G --> H[TSharkEnhancedMaskProcessor]
    H --> I[é˜¶æ®µ1: TSharkTLSAnalyzer]
    I --> J[é˜¶æ®µ2: TLSMaskRuleGenerator] 
    J --> K[é˜¶æ®µ3: ScapyMaskApplier]
    
    %% === TSharkåˆ†æé˜¶æ®µ ===
    I --> I1[TSharkè¿›ç¨‹è°ƒç”¨]
    I1 --> I2[TCPæµé‡ç»„<br/>IPç¢ç‰‡é‡ç»„]
    I2 --> I3[TLSåè®®è§£æ]
    I3 --> I4[TLSRecordç»“æ„]
    
    %% === è§„åˆ™ç”Ÿæˆé˜¶æ®µ ===
    J --> J1[åè®®ç±»å‹è¯†åˆ«]
    J1 --> J2[TLSç­–ç•¥åº”ç”¨<br/>20/21/22:ä¿ç•™<br/>23:æ©ç <br/>24:ä¿ç•™]
    J2 --> J3[è·¨åŒ…åˆ†æ®µå¤„ç†]
    J3 --> J4[MaskRuleç”Ÿæˆ]
    
    %% === Scapyåº”ç”¨é˜¶æ®µ ===
    K --> K1[åºåˆ—å·åŒ¹é…]
    K1 --> K2[è½½è·å­—èŠ‚ä¿®æ”¹]
    K2 --> K3[æ ¡éªŒå’Œé‡è®¡ç®—]
    K3 --> K4[ProcessorResult]
    
    %% === ç»“æœè½¬æ¢ ===
    K4 --> L[ProcessorStageAdapter<br/>ç»“æœè½¬æ¢]
    L --> M[StageStats<br/>æ©ç ç»Ÿè®¡]
    
    %% === æœ€ç»ˆè¾“å‡º ===
    M --> N[ä¸´æ—¶ç›®å½•æ¸…ç†]
    N --> O[è¾“å‡ºæ–‡ä»¶<br/>PCAP/PCAPNG]
    O --> P[ProcessResult<br/>å®Œæ•´ç»Ÿè®¡]
    
    %% === æ ·å¼å®šä¹‰ ===
    classDef stageNode fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef processorNode fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef analyzerNode fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef dataNode fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef configNode fill:#fff8e1,stroke:#ffa000,stroke-width:2px
    
    class D,E,F stageNode
    class D1,E1,H,I,J,K processorNode  
    class I1,I2,I3,J1,J2,K1,K2 analyzerNode
    class D5,E5,M,P dataNode
    class C,F1 configNode
```

### PySharkAnalyzer åœ¨ä¸»é“¾è·¯ä¸­çš„ä½ç½®

**âŒ PySharkAnalyzer ä¸åœ¨ Processor Adapter Mode ä¸»é“¾è·¯ä¸­**

- **å½“å‰ä¸»é“¾è·¯**: TSharkTLSAnalyzer â†’ TLSMaskRuleGenerator â†’ ScapyMaskApplier
- **PySharkAnalyzer ä½ç½®**: ä»…åœ¨ Enhanced Mode (å·²å¼ƒç”¨) ä¸­ä½¿ç”¨
- **è·¯å¾„**: `src/pktmask/core/trim/stages/pyshark_analyzer.py` (ç‹¬ç«‹ç»„ä»¶)

---

## ğŸ“Š æ¨¡å¼2: Pipelineæ¶æ„ - Basic Mode (é™çº§)

### é™çº§é“¾è·¯æµç¨‹å›¾

```mermaid
graph TD
    %% === é™çº§è§¦å‘ç‚¹ ===
    A[Processor Adapter Mode] --> B{åˆå§‹åŒ–æ£€æŸ¥}
    B -->|TSharkEnhanced<br/>å¯¼å…¥å¤±è´¥| C[é™çº§åˆ°Basic Mode]
    B -->|ProcessorStage<br/>Adapterå¤±è´¥| C
    
    %% === Basic Mode é“¾è·¯ ===
    C --> D[MaskStage<br/>Basic Mode]
    D --> E{é…æ–¹æ£€æŸ¥}
    
    %% === é€ä¼ æ¨¡å¼ ===
    E -->|æ— æœ‰æ•ˆé…æ–¹| F[é€ä¼ æ¨¡å¼]
    F --> F1[Scapy rdpcap]
    F1 --> F2[ç›´æ¥å¤åˆ¶åŒ…]
    F2 --> F3[Scapy wrpcap]
    F3 --> F4[StageStats<br/>mode=bypass]
    
    %% === æ©ç æ¨¡å¼ ===
    E -->|é…æ–¹å­˜åœ¨| G[BlindPacketMasker]
    G --> G1[MaskingRecipe<br/>è§£æ]
    G1 --> G2[JSONé…æ–¹æ–‡ä»¶<br/>æˆ–å­—å…¸é…ç½®]
    G2 --> G3[åŒ…çº§åˆ«æ©ç åº”ç”¨]
    G3 --> G4[StageStats<br/>mode=basic_masking]
    
    %% === æ‰§è¡Œæ—¶é™çº§ ===
    A --> H{process_fileæ‰§è¡Œ}
    H -->|ProcessorAdapter<br/>å¼‚å¸¸| I[è¿è¡Œæ—¶é™çº§]
    I --> J[Basic Mode Fallback]
    J --> J1[ç®€å•æ–‡ä»¶å¤åˆ¶]
    J1 --> J2[StageStats<br/>mode=fallback]
    
    %% === æ ·å¼å®šä¹‰ ===
    classDef stageNode fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef fallbackNode fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    classDef dataNode fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef configNode fill:#fff8e1,stroke:#ffa000,stroke-width:2px
    
    class D stageNode
    class C,I,J fallbackNode
    class F4,G4,J2 dataNode
    class B,E,H configNode
```

---

## ğŸ“Š æ¨¡å¼3: Directè°ƒç”¨æ¨¡å¼ (æ—§æ¶æ„ä¿ç•™)

### EnhancedTrimmer ç›´æ¥è°ƒç”¨é“¾è·¯

```mermaid
graph TD
    %% === ç›´æ¥è°ƒç”¨å…¥å£ ===
    A[ç›´æ¥è°ƒç”¨<br/>EnhancedTrimmer] --> B[MultiStageExecutor]
    
    %% === ä¸‰é˜¶æ®µå¤„ç† ===
    B --> C[Stage0: TSharkPreprocessor]
    B --> D[Stage1: PySharkAnalyzer] 
    B --> E[Stage2: TcpPayloadMaskerAdapter]
    
    %% === TSharké¢„å¤„ç†é˜¶æ®µ ===
    C --> C1[TSharkè¿›ç¨‹å¯åŠ¨]
    C1 --> C2[TCPæµé‡ç»„<br/>-z follow,tcp,ascii]
    C2 --> C3[TLSåˆ†æ®µé‡ç»„<br/>-o tls.desegment]
    C3 --> C4[é¢„å¤„ç†PCAPè¾“å‡º]
    
    %% === PySharkåˆ†æé˜¶æ®µ ===
    D --> D1[PyShark FileCapture]
    D1 --> D2[ğŸ¯ PySharkAnalyzer<br/>æ ¸å¿ƒåè®®åˆ†æ]
    D2 --> D3[TCPæµç®¡ç†å™¨]
    D3 --> D4[åè®®ç­–ç•¥å·¥å‚]
    D4 --> D5[TLS/HTTP/DNSç­–ç•¥]
    D5 --> D6[SequenceMaskTableç”Ÿæˆ]
    
    %% === Scapyåº”ç”¨é˜¶æ®µ ===
    E --> E1[æ©ç è¡¨è§£æ]
    E1 --> E2[TCPåºåˆ—å·åŒ¹é…]
    E2 --> E3[è½½è·å­—èŠ‚æ›¿æ¢]
    E3 --> E4[ScapyåŒ…é‡æ„]
    E4 --> E5[SimpleExecutionResult]
    
    %% === ç»“æœè¾“å‡º ===
    C4 --> F[Stageé—´æ•°æ®ä¼ é€’]
    D6 --> F
    E5 --> G[æœ€ç»ˆè¾“å‡ºæ–‡ä»¶]
    
    %% === æ ·å¼å®šä¹‰ ===
    classDef pysharkNode fill:#ff8a65,stroke:#d84315,stroke-width:3px
    classDef stageNode fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef processorNode fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef dataNode fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    
    class D2 pysharkNode
    class C,D,E stageNode
    class C1,D1,E1 processorNode
    class D6,E5,G dataNode
```

**âœ… PySharkAnalyzer åœ¨ EnhancedTrimmer é“¾è·¯ä¸­çš„æ ¸å¿ƒä½ç½®**

- **æ–‡ä»¶ä½ç½®**: `src/pktmask/core/trim/stages/pyshark_analyzer.py`
- **åŠŸèƒ½è§’è‰²**: Stage1 æ ¸å¿ƒåè®®åˆ†æå™¨
- **ä¸»è¦èŒè´£**: 
  - æ·±åº¦åè®®è¯†åˆ« (TLS/HTTP/DNS/ICMP)
  - TCPæµç®¡ç†å’Œæ–¹å‘æ€§æ£€æµ‹
  - åºåˆ—å·èŒƒå›´è®¡ç®—
  - SequenceMaskTableç”Ÿæˆ
  - TLSé‡ç»„åŒ…æ£€æµ‹å’Œæ ‡è®°

---

## ğŸ“Š æ¨¡å¼4: GUIè°ƒç”¨æ¨¡å¼ (ProcessorRegistryæ¡¥æ¥)

### GUIé›†æˆæ¶æ„

```mermaid
graph TD
    %% === GUIå±‚ ===
    A[GUIä¸»ç•Œé¢] --> B[PipelineManager]
    B --> C[é…ç½®æ„å»ºå™¨]
    C --> D[PipelineExecutoråˆ›å»º]
    
    %% === ProcessorRegistryæ¡¥æ¥ ===
    A --> E[ç›´æ¥å¤„ç†å™¨è°ƒç”¨]
    E --> F[ProcessorRegistry]
    F --> G[MaskingProcessor]
    G --> H[EnhancedTrimmerå§”æ‰˜]
    
    %% === ç»Ÿä¸€åˆ°Pipeline ===
    D --> I[Pipelineæ¨¡å¼æ‰§è¡Œ]
    H --> J[ç›´æ¥æ¨¡å¼æ‰§è¡Œ]
    
    %% === ç»“æœæ”¶é›† ===
    I --> K[StatisticsManager]
    J --> K
    K --> L[GUIç»“æœå±•ç¤º]
    
    %% === æ ·å¼å®šä¹‰ ===
    classDef guiNode fill:#e8eaf6,stroke:#3f51b5,stroke-width:2px
    classDef registryNode fill:#fff3e0,stroke:#f57c00,stroke-width:2px
    classDef dataNode fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    
    class A,B,L guiNode
    class F,G registryNode
    class K dataNode
```

---

## ğŸ”„ é™çº§è·¯å¾„è¯¦ç»†è¯´æ˜

### 1. TSharkEnhancedMaskProcessor é™çº§æœºåˆ¶

```mermaid
graph TD
    A[TSharkEnhanced<br/>MaskProcessor] --> B{TSharkå¯ç”¨æ€§æ£€æŸ¥}
    B -->|TSharkä¸å¯ç”¨| C[é™çº§åˆ°MaskStage]
    B -->|TSharkå¯ç”¨| D{åè®®è§£æ}
    D -->|è§£æå¤±è´¥| C
    D -->|å…¶ä»–é”™è¯¯| E[é‡è¯•æœºåˆ¶]
    E -->|é‡è¯•å¤±è´¥| C
    C --> F[æ ‡å‡†MaskStageå¤„ç†]
    
    classDef errorNode fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    class C,E errorNode
```

### 2. MaskStage å†…éƒ¨é™çº§æœºåˆ¶

```mermaid
graph TD
    A[MaskStageåˆå§‹åŒ–] --> B{æ¨¡å¼é€‰æ‹©}
    B -->|processor_adapter| C{ProcessorStage<br/>Adapteråˆ›å»º}
    C -->|æˆåŠŸ| D[Processor Adapter Mode]
    C -->|å¤±è´¥| E[é™çº§åˆ°Basic Mode]
    B -->|basic| F[Basic Mode]
    
    D --> G{æ‰§è¡Œé˜¶æ®µ}
    G -->|æˆåŠŸ| H[æ­£å¸¸ç»“æœ]
    G -->|å¤±è´¥| I[è¿è¡Œæ—¶é™çº§]
    I --> J[Fallback Mode<br/>ç®€å•å¤åˆ¶]
    
    classDef normalNode fill:#e8f5e8,stroke:#388e3c,stroke-width:2px
    classDef fallbackNode fill:#ffebee,stroke:#d32f2f,stroke-width:2px
    
    class D,H normalNode
    class E,I,J fallbackNode
```

### 3. EnhancedTrimmer å†…éƒ¨é™çº§ (æ·±å±‚é™çº§)

æ ¹æ®æ–‡æ¡£ `MASK_STAGE_EXECUTION_FLOW_ANALYSIS.md`ï¼š

| é”™è¯¯ä¸Šä¸‹æ–‡ | é™çº§æ¨¡å¼ | å…·ä½“å¤„ç† |
|------------|----------|----------|
| "TSharkä¸å¯ç”¨" | ENHANCED_TRIMMER | åˆ‡æ¢åˆ° EnhancedTrimmer å¤„ç†å™¨ |
| "tshark command failed" | ENHANCED_TRIMMER | åˆ‡æ¢åˆ° EnhancedTrimmer å¤„ç†å™¨ |
| "åè®®è§£æå¤±è´¥" | MASK_STAGE | åˆ‡æ¢åˆ° MaskStage å¤„ç†å™¨ |
| "protocol parsing error" | MASK_STAGE | åˆ‡æ¢åˆ° MaskStage å¤„ç†å™¨ |
| "unknown error" | ENHANCED_TRIMMER | é»˜è®¤åˆ‡æ¢åˆ° EnhancedTrimmer |

**å¤šçº§é™çº§çº§è”è·¯å¾„**:
```
TShark ä¸»å¤„ç†å¤±è´¥ â†’ EnhancedTrimmer â†’ MaskStage â†’ å®Œå…¨å¤±è´¥
åè®®è§£æå¤±è´¥ â†’ MaskStage â†’ EnhancedTrimmer â†’ å®Œå…¨å¤±è´¥
å…¶ä»–é”™è¯¯ â†’ EnhancedTrimmer â†’ MaskStage â†’ å®Œå…¨å¤±è´¥
```

---

## ğŸ“ ç»„ä»¶ä¾èµ–å…³ç³»æ€»ç»“

### Stage/Processor èŠ‚ç‚¹åˆ—è¡¨

| ç±»å‹ | ç»„ä»¶åç§° | æ–‡ä»¶è·¯å¾„ | ä¸»è¦åŠŸèƒ½ |
|------|----------|----------|----------|
| **Pipeline Stages** | | | |
| Stage | DedupStage | `core/pipeline/stages/dedup.py` | æ•°æ®åŒ…å»é‡ |
| Stage | AnonStage | `core/pipeline/stages/anon_ip.py` | IPåœ°å€åŒ¿ååŒ– |
| Stage | MaskStage | `core/pipeline/stages/mask_payload/stage.py` | è½½è·æ©ç (åŒæ¨¡å¼) |
| **Processors** | | | |
| Processor | Deduplicator | `core/processors/deduplicator.py` | å“ˆå¸Œå»é‡å¤„ç† |
| Processor | IPAnonymizer | `core/processors/ip_anonymizer.py` | åˆ†å±‚IPåŒ¿ååŒ– |
| Processor | TSharkEnhancedMaskProcessor | `core/processors/tshark_enhanced_mask_processor.py` | TSharkå¢å¼ºæ©ç  |
| **Analyzer Components** | | | |
| âŒ Analyzer | PySharkAnalyzer | `core/trim/stages/pyshark_analyzer.py` | **ä¸åœ¨ä¸»é“¾è·¯** |
| Analyzer | TSharkTLSAnalyzer | `core/processors/tshark_tls_analyzer.py` | TShark TLSåˆ†æ |
| Analyzer | TLSMaskRuleGenerator | `core/processors/tls_mask_rule_generator.py` | TLSæ©ç è§„åˆ™ç”Ÿæˆ |
| Analyzer | ScapyMaskApplier | `core/processors/scapy_mask_applier.py` | Scapyæ©ç åº”ç”¨ |
| **Adapters** | | | |
| Adapter | ProcessorStageAdapter | `core/pipeline/stages/processor_stage_adapter.py` | Processorâ†’Stageé€‚é… |
| **Legacy Components** | | | |
| Legacy | EnhancedTrimmer | `core/processors/enhanced_trimmer.py` | å®Œæ•´å¤šé˜¶æ®µå¤„ç† |
| Legacy | MultiStageExecutor | `core/trim/multi_stage_executor.py` | å¤šé˜¶æ®µæ‰§è¡Œå™¨ |

### æ•°æ®æµå‘è¯´æ˜

1. **æ–‡ä»¶æµå‘**: PCAPè¾“å…¥ â†’ Stageé“¾å¼å¤„ç† â†’ PCAPè¾“å‡º
2. **å‡½æ•°è°ƒç”¨æµå‘**: PipelineExecutor â†’ Stages â†’ Processors â†’ åº•å±‚å·¥å…·
3. **é…ç½®ä¼ æ’­**: é¡¶å±‚config â†’ Stageé…ç½® â†’ Processoré…ç½®
4. **ç»Ÿè®¡æ”¶é›†**: åº•å±‚ç»“æœ â†’ ProcessorResult â†’ StageStats â†’ ProcessResult
5. **é”™è¯¯ä¼ æ’­**: å¼‚å¸¸æ•è· â†’ é™çº§å¤„ç† â†’ ç»“æœæ ‡è®°

### PySharkAnalyzer æ€»ç»“

- **ä¸»é“¾è·¯åœ°ä½**: âŒ **ä¸åœ¨å½“å‰ç”Ÿäº§ä¸»é“¾è·¯ä¸­**
- **å®é™…ä½ç½®**: EnhancedTrimmerçš„Stage1ç»„ä»¶ (æ—§æ¶æ„)
- **åŠŸèƒ½ä»·å€¼**: æ·±åº¦åè®®åˆ†æï¼Œåºåˆ—å·æ©ç è¡¨ç”Ÿæˆ
- **æœªæ¥è§„åˆ’**: å¯èƒ½é›†æˆåˆ°æ–°æ¶æ„çš„å¢å¼ºåŠŸèƒ½ä¸­

---

**æ–‡æ¡£çŠ¶æ€**: âœ… å®Œæˆ  
**è¦†ç›–èŒƒå›´**: ä¸¤ç§æ¨¡å¼ + é™çº§è·¯å¾„ + PySharkAnalyzerå®šä½  
**ç»´æŠ¤è€…**: PktMask Development Team
